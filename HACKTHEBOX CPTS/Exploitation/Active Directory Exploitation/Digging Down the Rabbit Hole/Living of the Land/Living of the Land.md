# Scenario

- When a client wants us to test the network without internet connection or access to our tools
- We have to utilize native Windows/Active Directory

# Env Commands For Host & Network Recon

- Command that give us information on the host we are on

## Basic Enumeration Commands

|**Command**|**Result**|
|---|---|
|`hostname`|**Pri**nts **th**e **PC**'s **Na**me|
|`[System.Environment]::OSVersion.Version`|**Pri**nts **ou**t **th**e **O**S **vers**ion **an**d **revi**sion **lev**el|
|`wmic qfe get Caption,Description,HotFixID,InstalledOn`|**Pri**nts **th**e **patc**hes **an**d **hotf**ixes **appl**ied **t**o **th**e **ho**st|
|`ipconfig /all`|**Pri**nts **ou**t **netw**ork **adap**ter **sta**te **an**d **confi**gurations|
|`set`|**Disp**lays **a** **li**st **o**f **envir**onment **vari**ables **fo**r **th**e **curr**ent **sess**ion (**ra**n **fr**om **CM**D-**pro**mpt)|
|`echo %USERDOMAIN%`|**Disp**lays **th**e **dom**ain **na**me **t**o **whi**ch **th**e **ho**st **belo**ngs (**ra**n **fr**om **CM**D-**pro**mpt)|
|`echo %logonserver%`|**Pri**nts **ou**t **th**e **na**me **o**f **th**e **Dom**ain **contr**oller **th**e **ho**st **che**cks **i**n **wi**th (**ra**n **fr**om **CM**D-**pro**mpt)|

## Systeminfo

- **pri**nt **a** **summ**ary **o**f **th**e **hos**t's **infor**mation **fo**r **u**s **i**n **on**e **ti**dy **out**put

![[Notion/CPTS/RESOURCES/image 20.png|image 20.png]]

---

# PowerShell

## Quick Checks using Powershell

```Shell
Get-Module
```

```Shell
Get-ExecutionPolicy -List
```

```Shell
whoami
```

```Shell
Get-ChildItem Env: | ft key,value
```

## Downgrading Powershell

- Useful because if we downgrade from Powershell 3.0 to Powershell 2.0, the events will not be logged

```Shell
Get-host
```

```Shell
powershell.exe -version 2

#\#Test that it worked
Get-host
```

```Shell
get-module
```

---

# Checking Defenses

## Firewall Checks

```Shell
netsh advfirewall show allprofiles
```

## Windows Defender Check (from cmd.exe)

- Check if defender is running

```Shell
sc query windefend
```

## Get-MpComputerStatus

- Check the status and configuration of Defender

```Shell
Get-MpComputerStatus
```

---

# Check if other users are logged in

- **impo**rtant **thi**ng **i**s **t**o **che**ck **an**d **se**e **i**f **yo**u **ar**e **th**e **on**ly **on**e **log**ged **i**n

## Using qwinsta

```Shell
qwinsta
```

---

# Network Information

## Using arp -a

```Shell
PS C:\htb> arp -a

Interface: 172.16.5.25 --- 0x8
  Internet Address      Physical Address      Type
  172.16.5.5            00-50-56-b9-08-26     dynamic
  172.16.5.130          00-50-56-b9-f0-e1     dynamic
  172.16.5.240          00-50-56-b9-9d-66     dynamic
  224.0.0.22            01-00-5e-00-00-16     static
  224.0.0.251           01-00-5e-00-00-fb     static
  224.0.0.252           01-00-5e-00-00-fc     static
  239.255.255.250       01-00-5e-7f-ff-fa     static

Interface: 10.129.201.234 --- 0xc
  Internet Address      Physical Address      Type
  10.129.0.1            00-50-56-b9-b9-fc     dynamic
  10.129.202.29         00-50-56-b9-26-8d     dynamic
  10.129.255.255        ff-ff-ff-ff-ff-ff     static
  224.0.0.22            01-00-5e-00-00-16     static
  224.0.0.251           01-00-5e-00-00-fb     static
  224.0.0.252           01-00-5e-00-00-fc     static
  239.255.255.250       01-00-5e-7f-ff-fa     static
  255.255.255.255       ff-ff-ff-ff-ff-ff     static
```

## Viewing the Routing Table

```Shell
route print
```

> [!important] **Usi**ng `arp -a` **an**d `route print` **wi**ll **no**t **on**ly **bene**fit **i**n **enume**rating **A**D **envir**onments, **bu**t **wi**ll **al**so **ass**ist **u**s **i**n **ident**ifying **oppor**tunities **t**o **piv**ot **t**o **diff**erent **netw**ork **segm**ents **i**n **an**y **envir**onment.

---

# Windows Management Instrumentation (WMI)

[https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4](https://gist.github.com/xorrior/67ee741af08cb1fc86511047550cdaf4)

## Cheatsheet

```Shell
Host Enumeration:

--- OS Specifics ---
wmic os LIST Full (* To obtain the OS Name, use the "caption" property)

wmic computersystem LIST full

--- Anti-Virus ---

wmic /namespace:\\root\securitycenter2 path antivirusproduct

--- Peripherals ---
wmic path Win32_PnPdevice 

--- Installed Updates ---
wmic qfe list brief

--- Directory Listing and File Search ---

wmic DATAFILE where "path='\\Users\\test\\Documents\\'" GET Name,readable,size

wmic DATAFILE where "drive='C:' AND Name like '%password%'" GET Name,readable,size /VALUE

--- Local User Accounts ---

wmic USERACCOUNT Get Domain,Name,Sid

Domain Enumeration:

--- Domain and DC Info ---

wmic NTDOMAIN GET DomainControllerAddress,DomainName,Roles /VALUE

--- Domain User Info ---

wmic /NAMESPACE:\\root\directory\ldap PATH ds_user where "ds_samaccountname='testAccount'" GET 


--- List All Users ---

wmic /NAMESPACE:\\root\directory\ldap PATH ds_user GET ds_samaccountname

--- List All Groups ---

wmic /NAMESPACE:\\root\directory\ldap PATH ds_group GET ds_samaccountname

--- Members of A Group ---

wmic /NAMESPACE:\\root\directory\ldap PATH ds_group where "ds_samaccountname='Domain Admins'" Get ds_member /Value
wmic path win32_groupuser where (groupcomponent="win32_group.name="domain admins",domain="YOURDOMAINHERE"")

--- List All Computers ---

wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_samaccountname

OR

wmic /NAMESPACE:\\root\directory\ldap PATH ds_computer GET ds_dnshostname

Misc:

--- Execute Remote Command ---

wmic process call create "cmd.exe /c calc.exe"

--- Enable Remote Desktop ---

wmic rdtoggle where AllowTSConnections="0" call SetAllowTSConnections "1"

OR

wmic /node:remotehost path Win32_TerminalServiceSetting where AllowTSConnections="0" call SetAllowTSConnections "1"
```

## Quick WMI Checks

|**Command**|**Description**|
|---|---|
|`wmic qfe get Caption,Description,HotFixID,InstalledOn`|**Pri**nts **th**e **pat**ch **lev**el **an**d **descr**iption **o**f **th**e **Hotf**ixes **appl**ied|
|`wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List`|**Disp**lays **bas**ic **ho**st **infor**mation **t**o **incl**ude **an**y **attri**butes **wit**hin **th**e **li**st|
|`wmic process list /format:list`|**A** **list**ing **o**f **al**l **proc**esses **o**n **ho**st|
|`wmic ntdomain list /format:list`|**Disp**lays **infor**mation **abo**ut **th**e **Dom**ain **an**d **Dom**ain **Contr**ollers|
|`wmic useraccount list /format:list`|**Disp**lays **infor**mation **abo**ut **al**l **loc**al **acco**unts **an**d **an**y **dom**ain **acco**unts **th**at **ha**ve **log**ged **in**to **th**e **dev**ice|
|`wmic group list /format:list`|**Infor**mation **abo**ut **al**l **loc**al **gro**ups|
|`wmic sysaccount list /format:list`|**Dum**ps **infor**mation **abo**ut **an**y **sys**tem **acco**unts **th**at **ar**e **bei**ng **us**ed **a**s **serv**ice **acco**unts.|

## Documentation WMI

[https://docs.microsoft.com/en-us/windows/win32/wmisdk/using-wmi](https://docs.microsoft.com/en-us/windows/win32/wmisdk/using-wmi)

---

# Net Commands

[Net](https://docs.microsoft.com/en-us/windows/win32/winsock/net-exe-2) **comm**ands **ca**n **b**e **benef**icial **t**o **u**s **wh**en **attem**pting **t**o **enum**erate **infor**mation **fr**om **th**e **dom**ain. **The**se **comm**ands **ca**n **b**e **us**ed **t**o **que**ry **th**e **loc**al **ho**st **an**d **rem**ote **hos**ts, **mu**ch **li**ke **th**e **capab**ilities **prov**ided **b**y **WM**I. **W**e **ca**n **li**st **infor**mation **su**ch **a**s:

- **Loc**al **an**d **dom**ain **use**rs
- **Gro**ups
- **Hos**ts
- **Spec**ific **use**rs **i**n **gro**ups
- **Dom**ain **Contr**ollers
- **Pass**word **requi**rements

## Bypassing EDR monitoring Net

- You can use the net1 instead of net command

## Table of Useful Net Commands

|**Command**|**Description**|
|---|---|
|`net accounts`|**Infor**mation **abo**ut **pass**word **requi**rements|
|`net accounts /domain`|**Pass**word **an**d **lock**out **pol**icy|
|`net group /domain`|**Infor**mation **abo**ut **dom**ain **gro**ups|
|`net group "Domain Admins" /domain`|**Li**st **use**rs **wi**th **dom**ain **adm**in **privi**leges|
|`net group "domain computers" /domain`|**Li**st **o**f **PC**s **conn**ected **t**o **th**e **dom**ain|
|`net group "Domain Controllers" /domain`|**Li**st **P**C **acco**unts **o**f **doma**ins **contr**ollers|
|`net group <domain_group_name> /domain`|**Us**er **th**at **belo**ngs **t**o **th**e **gro**up|
|`net groups /domain`|**Li**st **o**f **dom**ain **gro**ups|
|`net localgroup`|**Al**l **avai**lable **gro**ups|
|`net localgroup administrators /domain`|**Li**st **use**rs **th**at **bel**ong **t**o **th**e **admin**istrators **gro**up **ins**ide **th**e **dom**ain (**th**e **gro**up `Domain Admins` **i**s **incl**uded **he**re **b**y **defa**ult)|
|`net localgroup Administrators`|**Infor**mation **abo**ut **a** **gro**up (**adm**ins)|
|`net localgroup administrators [username] /add`|**Ad**d **us**er **t**o **admin**istrators|
|`net share`|**Che**ck **curr**ent **sha**res|
|`net user <ACCOUNT_NAME> /domain`|**Ge**t **infor**mation **abo**ut **a** **us**er **wit**hin **th**e **dom**ain|
|`net user /domain`|**Li**st **al**l **use**rs **o**f **th**e **dom**ain|
|`net user %username%`|**Infor**mation **abo**ut **th**e **curr**ent **us**er|
|`net use x: \computer\share`|**Mou**nt **th**e **sha**re **loca**lly|
|`net view`|**Ge**t **a** **li**st **o**f **comp**uters|
|`net view /all /domain[:domainname]`|**Sha**res **o**n **th**e **doma**ins|
|`net view \computer /ALL`|**Li**st **sha**res **o**f **a** **comp**uter|
|`net view /domain`|**Li**st **o**f **PC**s **o**f **th**e **dom**ain|

---

# Dsquery

[Dsquery](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952\(v=ws.11\)) **i**s **a** **help**ful **comm**and **li**ne **to**ol **th**at **ca**n **b**e **util**ized **t**o **fi**nd **Act**ive **Dire**ctory **obje**cts

## Prerequisites

**Al**l **w**e **ne**ed **i**s **elev**ated **privi**leges **o**n **a** **ho**st **o**r **th**e **abil**ity **t**o **ru**n **a**n **inst**ance **o**f **Comm**and **Pro**mpt **o**r **Power**Shell **fr**om **a** `SYSTEM` **cont**ext

## User Search

```Shell
dsquery user
```

## Computer Search

```Shell
dsquery computer
```

## Wildcard Search

```Shell
dsquery * "CN=Users,DC=INLANEFREIGHT,DC=LOCAL"
```

- **vi**ew **al**l **obje**cts **i**n **a**n **O**U

## **Users With Specific Attributes Set (PASSWD_NOTREQD)**

```Shell
PS C:\htb> dsquery * -filter "(&(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))" -attr distinguishedName userAccountControl

  distinguishedName                                                                              userAccountControl
  CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                                    66082
  CN=Marion Lowe,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL      66080
  CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    66080
  CN=Eileen Hamilton,OU=DevOps,OU=IT,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    66080
  CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                           546
  CN=NAGIOSAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL                           544
  CN=LOGISTICS$,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                               2080
  CN=FREIGHTLOGISTIC$,CN=Users,DC=INLANEFREIGHT,DC=LOCAL 
```

## **Searching for Domain Controllers**

```Shell
PS C:\Users\forend.INLANEFREIGHT> dsquery * -filter "(userAccountControl:1.2.840.113556.1.4.803:=8192)" -limit 5 -attr sAMAccountName

 sAMAccountName
 ACADEMY-EA-DC01$
```