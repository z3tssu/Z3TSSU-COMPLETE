- When you have a valid domain account on a domain network
- You can perform the following:

# **ActiveDirectory PowerShell Module**

[https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps)

## Import the Tool

1. Check if it is imported 
    
    ```Shell
    Get-Module
    ```
    
2. Load ActiveDirectory Module
    
    ```Shell
    PS C:\htb> Import-Module ActiveDirectory
    PS C:\htb> Get-Module
    ```
    

## Enumeration

### 1. Get Domain info

```Shell
Get-ADDomain
```

### 2. Get-ADUser

- Filtering accounts with ServicePrincipalName
- Give a list of accounts that may be vulnerable to Kerberoasting

```Shell
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
```

```Shell
Get-ADTrust -Filter *
```

- It will print out the trust relationships the domain has

### 4. Group Enumeration

1. Simple Query

```Shell
Get-ADGroup -Filter * | select name
```

1. Filter with Group Name

```Shell
Get-ADGroup -Identity "Backup Operators"
```

### 5. Group Membership

1. **No**w **th**at **w**e **kn**ow **mo**re **abo**ut **th**e **gro**up, **let**'s **ge**t **a** **mem**ber **list**ing **usi**ng **th**e [Get-ADGroupMember](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adgroupmember?view=windowsserver2022-ps) **cmd**let.  
    

```Shell
Get-ADGroupMember -Identity "Backup Operators"
```

---

# PowerView

- [PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon) **i**s **a** **to**ol **writ**ten **i**n **Power**Shell **t**o **he**lp **u**s **ga**in **situa**tional **awar**eness **wit**hin **a**n **A**D **envir**onment.
- Used to identify the following:
    - **whe**re **use**rs **ar**e **log**ged **i**n **o**n **a** **netw**ork
    - **enum**erate **dom**ain **infor**mation **su**ch **a**s **use**rs, **comp**uters, **gro**ups, **AC**LS, **tru**sts, 
    - **hu**nt **fo**r **fi**le **sha**res **an**d **pass**words
    - **perf**orm **Kerbe**roasting, **an**d **mo**re.

## PowerView Useful Commands Cheatsheet

|**Command**|**Description**|
|---|---|
|`Export-PowerViewCSV`|**App**end **resu**lts **t**o **a** **CS**V **fi**le|
|`ConvertTo-SID`|**Conv**ert **a** **Us**er **o**r **gro**up **na**me **t**o **it**s **SI**D **val**ue|
|`Get-DomainSPNTicket`|**Requ**ests **th**e **Kerb**eros **tic**ket **fo**r **a** **spec**ified **Serv**ice **Prin**cipal **Na**me (**SP**N) **acco**unt|
|**Domain/LDAP Functions:**||
|`Get-Domain`|**Wi**ll **ret**urn **th**e **A**D **obj**ect **fo**r **th**e **curr**ent (**o**r **spec**ified) **dom**ain|
|`Get-DomainController`|**Ret**urn **a** **li**st **o**f **th**e **Dom**ain **Contr**ollers **fo**r **th**e **spec**ified **dom**ain|
|`Get-DomainUser`|**Wi**ll **ret**urn **al**l **use**rs **o**r **spec**ific **us**er **obje**cts **i**n **A**D|
|`Get-DomainComputer`|**Wi**ll **ret**urn **al**l **comp**uters **o**r **spec**ific **comp**uter **obje**cts **i**n **A**D|
|`Get-DomainGroup`|**Wi**ll **ret**urn **al**l **gro**ups **o**r **spec**ific **gro**up **obje**cts **i**n **A**D|
|`Get-DomainOU`|**Sea**rch **fo**r **al**l **o**r **spec**ific **O**U **obje**cts **i**n **A**D|
|`Find-InterestingDomainAcl`|**Fin**ds **obj**ect **AC**Ls **i**n **th**e **dom**ain **wi**th **modif**ication **rig**hts **se**t **t**o **no**n-**bui**lt **i**n **obje**cts|
|`Get-DomainGroupMember`|**Wi**ll **ret**urn **th**e **memb**ers **o**f **a** **spec**ific **dom**ain **gro**up|
|`Get-DomainFileServer`|**Retu**rns **a** **li**st **o**f **serv**ers **lik**ely **funct**ioning **a**s **fi**le **serv**ers|
|`Get-DomainDFSShare`|**Retu**rns **a** **li**st **o**f **al**l **distr**ibuted **fi**le **syst**ems **fo**r **th**e **curr**ent (**o**r **spec**ified) **dom**ain|
|**GPO Functions:**||
|`Get-DomainGPO`|**Wi**ll **ret**urn **al**l **GP**Os **o**r **spec**ific **GP**O **obje**cts **i**n **A**D|
|`Get-DomainPolicy`|**Retu**rns **th**e **defa**ult **dom**ain **pol**icy **o**r **th**e **dom**ain **contr**oller **pol**icy **fo**r **th**e **curr**ent **dom**ain|
|**Computer Enumeration Functions:**||
|`Get-NetLocalGroup`|**Enume**rates **loc**al **gro**ups **o**n **th**e **loc**al **o**r **a** **rem**ote **mach**ine|
|`Get-NetLocalGroupMember`|**Enume**rates **memb**ers **o**f **a** **spec**ific **loc**al **gro**up|
|`Get-NetShare`|**Retu**rns **op**en **sha**res **o**n **th**e **loc**al (**o**r **a** **rem**ote) **mach**ine|
|`Get-NetSession`|**Wi**ll **ret**urn **sess**ion **infor**mation **fo**r **th**e **loc**al (**o**r **a** **rem**ote) **mach**ine|
|`Test-AdminAccess`|**Tes**ts **i**f **th**e **curr**ent **us**er **ha**s **admin**istrative **acc**ess **t**o **th**e **loc**al (**o**r **a** **rem**ote) **mach**ine|
|**Threaded 'Meta'-Functions:**||
|`Find-DomainUserLocation`|**Fin**ds **mach**ines **whe**re **spec**ific **use**rs **ar**e **log**ged **i**n|
|`Find-DomainShare`|**Fin**ds **reac**hable **sha**res **o**n **dom**ain **mach**ines|
|`Find-InterestingDomainShareFile`|**Sear**ches **fo**r **fil**es **matc**hing **spec**ific **crit**eria **o**n **read**able **sha**res **i**n **th**e **dom**ain|
|`Find-LocalAdminAccess`|**Fi**nd **mach**ines **o**n **th**e **loc**al **dom**ain **whe**re **th**e **curr**ent **us**er **ha**s **loc**al **admin**istrator **acc**ess|
|**Domain Trust Functions:**||
|`Get-DomainTrust`|**Retu**rns **dom**ain **tru**sts **fo**r **th**e **curr**ent **dom**ain **o**r **a** **spec**ified **dom**ain|
|`Get-ForestTrust`|**Retu**rns **al**l **for**est **tru**sts **fo**r **th**e **curr**ent **for**est **o**r **a** **spec**ified **for**est|
|`Get-DomainForeignUser`|**Enume**rates **use**rs **wh**o **ar**e **i**n **gro**ups **outs**ide **o**f **th**e **use**r's **dom**ain|
|`Get-DomainForeignGroupMember`|**Enume**rates **gro**ups **wi**th **use**rs **outs**ide **o**f **th**e **grou**p's **dom**ain **an**d **retu**rns **ea**ch **fore**ign **mem**ber|
|`Get-DomainTrustMapping`|**Wi**ll **enum**erate **al**l **tru**sts **fo**r **th**e **curr**ent **dom**ain **an**d **an**y **oth**ers **se**en.|

## Common PowerView Commands

### Domain User Information

```Shell
Get-DomainUser -Identity mmorgan -Domain inlanefreight.local | Select-Object -Property name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol
```

### Recursive Group Membership

- **recu**rsive **lo**ok **a**t **th**e `Domain Admins` **gro**up **t**o **li**st **it**s **memb**ers

```Shell
Get-DomainGroupMember -Identity "Domain Admins" -Recurse
```

### Trust Enumeration

```Shell
Get-DomainTrustMapping
```

### Testing for Local Admin Access

-  T**e**st **i**f **a** **us**er **ha**s **admin**istrative **acc**ess **t**o **a** **loc**al **o**r **rem**ote **ho**st  
    

```Shell
Test-AdminAccess -ComputerName ACADEMY-EA-MS01
```

### **Finding Users With SPN Set**

- **No**w **w**e **ca**n **che**ck **fo**r **use**rs **wi**th **th**e **SP**N **attr**ibute **se**t, **whi**ch **indi**cates **th**at **th**e **acco**unt **ma**y **b**e **subj**ected **t**o **a** **Kerbe**roasting **att**ack.

```Shell
Get-DomainUser -SPN -Properties samaccountname,ServicePrincipalName
```

---

# SharpView

## SharpView Help

```Shell
.\SharpView.exe Get-DomainUser -Help
```

## Enumerate User Information

```Shell
.\SharpView.exe Get-DomainUser -Identity forend
```

---

# Snaffler - Shares

[Snaffler](https://github.com/SnaffCon/Snaffler) **i**s **a** **to**ol **th**at **ca**n **he**lp **u**s **acqu**ire **crede**ntials **o**r **oth**er **sens**itive **da**ta **i**n **a**n **Act**ive **Dire**ctory **envir**onment.

## Snaffler Execution

```Shell
Snaffler.exe -s -d inlanefreight.local -o snaffler.log -v data
```

```Shell
.\Snaffler.exe  -d INLANEFREIGHT.LOCAL -s -v data
```

---

# Bloodhound

**A**s **disc**ussed **i**n **th**e **prev**ious **sect**ion, `Bloodhound` **i**s **a**n **excep**tional **op**en-**sou**rce **to**ol **th**at **ca**n **iden**tify **att**ack **pat**hs **wit**hin **a**n **A**D **envir**onment **b**y **anal**yzing **th**e **relat**ionships **betw**een **obje**cts. 

### Basic Overview

1. **w**e **mu**st **authe**nticate **a**s **a** **dom**ain **us**er **fr**om **a** **Wind**ows **att**ack **ho**st **posit**ioned **wit**hin **th**e **netw**ork
2. **o**r **tran**sfer **th**e **to**ol **t**o **a** **dom**ain-**joi**ned **ho**st

## Sharphound in Action

  

```Shell
.\SharpHound.exe --help
```

### Run the Sharphound collector (Attack Host)

```Shell
.\SharpHound.exe -c All --zipfilename ILFREIGHT
```

## Ingesting the Data into Bloodhound

1. On the Attack Host
2. Type in CMD or Powershell
    
    ```Shell
    bloodhound
    ```
    
3. Credentials are: ==**neo4j: HTB_@cademy_stdnt!**==
4. Click Upload Data on the right hand side
5. Select the zip file from Sharphound and click open

![[Notion/CPTS/RESOURCES/image 19.png|image 19.png]]

## Bloodhound Queries

1. Type ==domain== in the search bar
2. In the Analysis Tab

![[image 1 12.png|image 1 12.png]]

### Find K**erbe**roastable **acco**unts   

![[Notion/CPTS/RESOURCES/image 2 9.png|image 2 9.png]]

### Find Computers with Unsupported Operating Systems

- **gre**at **fo**r **find**ing **outd**ated **an**d **unsup**ported **oper**ating **syst**ems **runn**ing **leg**acy **soft**ware

![[Notion/CPTS/RESOURCES/image 3 6.png|image 3 6.png]]

- Outcome
    
    **Th**is **que**ry **sho**ws **tw**o **hos**ts, **on**e **runn**ing **Wind**ows **7** **an**d **on**e **runn**ing **Wind**ows **Ser**ver **20**08 (**bo**th **o**f **whi**ch **ar**e **no**t "**li**ve" **i**n **ou**r **la**b). **Some**times **w**e **wi**ll **se**e **hos**ts **th**at **ar**e **n**o **lon**ger **powe**red **o**n **bu**t **sti**ll **app**ear **a**s **reco**rds **i**n **A**D. **W**e **sho**uld **alw**ays **vali**date **whet**her **th**ey **ar**e "**li**ve" **o**r **no**t **bef**ore **mak**ing **recom**mendations **i**n **ou**r **repo**rts. **W**e **ma**y **wri**te **u**p **a** **hi**gh-**ri**sk **find**ing **fo**r **Leg**acy **Oper**ating **Syst**ems **o**r **a** **be**st **prac**tice **recom**mendation **fo**r **clea**ning **u**p **ol**d **reco**rds **i**n **A**D.
    

### Advising on Legacy System

- What to do
    
    **Old**er **hos**ts **ma**y **b**e **susce**ptible **t**o **old**er **rem**ote **co**de **exec**ution **vulne**rabilities **li**ke [MS08-067](https://support.microsoft.com/en-us/topic/ms08-067-vulnerability-in-server-service-could-allow-remote-code-execution-ac7878fc-be69-7143-472d-2507a179cd15). **I**f **w**e **co**me **acr**oss **the**se **old**er **hos**ts **dur**ing **a**n **asses**sment, **w**e **sho**uld **b**e **care**ful **bef**ore **atta**cking **th**em (**o**r **ev**en **che**ck **wi**th **ou**r **cli**ent) **a**s **th**ey **ma**y **b**e **frag**ile **an**d **runn**ing **a** **crit**ical **appli**cation **o**r **serv**ice. **W**e **ca**n **adv**ise **ou**r **cli**ent **t**o **segm**ent **the**se **hos**ts **of**f **fr**om **th**e **re**st **o**f **th**e **netw**ork **a**s **mu**ch **a**s **poss**ible **i**f **th**ey **can**not **rem**ove **th**em **ye**t, **bu**t **sho**uld **al**so **reco**mmend **th**at **th**ey **sta**rt **putt**ing **toge**ther **a** **pl**an **t**o **decom**mission **an**d **repl**ace **th**em  
      
    

### Find Computers where Domain Users are Local Admin

- **se**e **i**f **the**re **ar**e **an**y **hos**ts **whe**re **al**l **use**rs **ha**ve **loc**al **adm**in **rig**hts. 

![[Notion/CPTS/RESOURCES/image 4 5.png|image 4 5.png]]

# Important

> [!important] **Ke**ep **i**n **mi**nd **a**s **w**e **g**o **thro**ugh **th**e **engag**ement, **w**e **sho**uld **b**e **docum**enting **eve**ry **fi**le **th**at **i**s **trans**ferred **t**o **an**d **fr**om **hos**ts **i**n **th**e **dom**ain **an**d **whe**re **th**ey **we**re **pla**ced **o**n **di**sk. **Th**is **i**s **go**od **prac**tice **i**f **w**e **ha**ve **t**o **decon**flict **ou**r **acti**ons **wi**th **th**e **cust**omer. **Al**so, **depe**nding **o**n **th**e **sco**pe **o**f **th**e **engag**ement, **yo**u **wa**nt **t**o **ens**ure **yo**u **cov**er **yo**ur **tra**cks **an**d **cle**an **u**p **anyt**hing **yo**u **pu**t **i**n **th**e **envir**onment **a**t **th**e **concl**usion **o**f **th**e **engag**ement.

# Bloodhound Learning Resource

[https://academy.hackthebox.com/course/preview/active-directory-bloodhound](https://academy.hackthebox.com/course/preview/active-directory-bloodhound)

[https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/)