- [[#Overview]]
- [[#CrackMapExec]]
- [[#SMBMap]]
- [[#rpcclient]]
- [[#Impacket Toolkit]]
- [[#Windapsearch]]
- [[#Bloodhound]]

# Overview

### **Post-Foothold Domain Enumeration â€“ Key Notes**

**1. Objective:**

Now that initial access is gained, the goal is to **enumerate the domain** more deeply.

**2. Credentials in Use:**

- Enumeration will be conducted using **low-privilege domain user credentials**.
- Tools and techniques require **some level of valid domain user credentials**.

**3. Enumeration Focus Areas:**

- **Domain user attributes** (e.g., usernames, descriptions, logon times)
- **Computer attributes** (e.g., hostnames, OS versions)
- **Group memberships**
- **Group Policy Objects (GPOs)**
- **Permissions and ACLs (Access Control Lists)**
- **Domain trusts** (inter-domain relationships)
- **Other domain configurations**

**4. Credential Requirements:**

To use most tools, you must have at least one of the following:

- A **cleartext password** of a domain user
- A **NTLM password hash**
- **SYSTEM-level access** on a **domain-joined host**

**5. Reminder:**

Even low-privilege access can reveal a **significant amount of domain data** and pave the way for privilege escalation.

---

---

# CrackMapExec

[CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)Â (**CM**E,Â **no**wÂ **NetE**xec)Â **i**sÂ **a**Â **powe**rfulÂ **tool**setÂ **t**oÂ **he**lpÂ **wi**thÂ **asse**ssingÂ **A**DÂ **envir**onments.

## CME Help Menu

```Shell
crackmapexec -h
```

- **we**Â **ca**nÂ **us**eÂ **th**eÂ **too**lÂ **wit**hÂ **MSSQ**L,Â **SM**B,Â **SS**H,Â **an**dÂ **WinR**MÂ **creden**tials.Â **Let'**sÂ **loo**kÂ **at**Â **ou**rÂ **optio**nsÂ **fo**rÂ **CM**EÂ **wit**hÂ **th**eÂ **SM**BÂ **proto**col:

## **CMEÂ Options (SMB)**

```Shell
crackmapexec smb -h
```

## **CME -Â DomainÂ UserÂ Enumeration**

```Shell
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users
```

## **CME -Â DomainÂ GroupÂ Enumeration**

```Shell
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups
```

- **Tak**eÂ **not**eÂ **of**Â **ke**yÂ **grou**psÂ **lik**eÂ `Administrators`,Â `Domain Admins`,Â `Executives`

![[Notion/CPTS/RESOURCES/image 18.png|image 18.png]]

## **CME -Â LoggedÂ OnÂ Users**

```Shell
sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users
```

**We**Â **ca**nÂ **als**oÂ **us**eÂ **CM**EÂ **to**Â **targ**etÂ **othe**rÂ **host**s.Â 

## **CMEÂ ShareÂ Searching**

**enumer**ateÂ **availa**bleÂ **shar**esÂ **on**Â **th**eÂ **remo**teÂ **hos**tÂ **an**dÂ **th**eÂ **leve**lÂ **of**Â **acce**ssÂ **ou**rÂ **use**rÂ **accou**ntÂ **ha**sÂ **to**Â **eac**hÂ **shar**e

```Shell
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares
```

## **CMEÂ ShareÂ Searching - Spider_Plus**

**Th**eÂ **modu**leÂ `spider_plus`Â **wil**lÂ **di**gÂ **throu**ghÂ **eac**hÂ **reada**bleÂ **shar**eÂ **on**Â **th**eÂ **hos**tÂ **an**dÂ **lis**tÂ **al**lÂ **reada**bleÂ **file**s.Â **Let'**sÂ **giv**eÂ **it**Â **a**Â **tr**y.

```Shell
sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
```

- **CM**EÂ **writ**esÂ **th**eÂ **resul**tsÂ **to**Â **a**Â **JSO**NÂ **fil**eÂ **locat**edÂ **at**Â `/tmp/cme_spider_plus/<ip of host>`

```Shell
z3tssu@htb[/htb]$ head -n 10 /tmp/cme_spider_plus/172.16.5.5.json 

{
    "Department Shares": {
        "Accounting/Private/AddSelect.bat": {
            "atime_epoch": "2022-03-31 14:44:42",
            "ctime_epoch": "2022-03-31 14:44:39",
            "mtime_epoch": "2022-03-31 15:14:46",
            "size": "278 Bytes"
        },
        "Accounting/Private/ApproveConnect.wmf": {
            "atime_epoch": "2022-03-31 14:45:14",
     
<SNIP>
```

---

# SMBMap

- Overview
    
    ### **Purpose**
    
    - Tool used from a Linux attack host to enumerate SMB (Server Message Block) shares.
    
    ### **Key Functions**
    
    - List available SMB shares on remote systems.
    - Show permissions for each share.
    - View contents of shares (if accessible).
    - Recursively list directory contents.
    - Search for specific content inside files.
    - Upload and download files.
    - Execute commands remotely (if permissions allow).
    
    ### **Usage Context**
    
    - Useful during post-exploitation to gather intelligence from file shares.
    - Similar to CrackMapExec (CME) in functionality.
    
    ### **Authentication**
    
    - Requires domain user credentials:
        - Cleartext password, NTLM hash, or SYSTEM-level access on a domain-joined host.
    
    ### **Command Reference**
    
    - `smbmap -h` â€” Show help and usage options.
    
    ### **Best Use**
    
    - When you already have a low-privilege domain user and want to:
        - Discover misconfigurations.
        - Extract sensitive information from accessible shares.
        - Explore lateral movement opportunities.

## **SMBMapÂ ToÂ CheckÂ Access**

```Shell
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5
```

## **RecursiveÂ ListÂ OfÂ AllÂ Directories**

```Shell
smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only
```

---

# rpcclient

## Purpose

- A command-line tool used with the **Samba protocol** to interact with **Windows systems** via **MS-RPC (Microsoft Remote Procedure Call)**.

### **Capabilities**

- Can **enumerate**, **add**, **modify**, and **remove** objects in **Active Directory**.
- Useful for interacting with Windows services remotely over SMB/RPC.

  

## rpcclient **unauthen**ticated connection

```Shell
rpcclient -U "" -N 172.16.5.5
```

## **RPCClientÂ UserÂ EnumerationÂ ByÂ RID**

```Shell
rpcclient $> queryuser 0x457
```

## RCPClient **Enumdomusers**

```Shell
rpcclient $> enumdomusers

user:[administrator] rid:[0x1f4]
user:[guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[lab_adm] rid:[0x3e9]
user:[htb-student] rid:[0x457]
user:[avazquez] rid:[0x458]
user:[pfalcon] rid:[0x459]
user:[fanthony] rid:[0x45a]
user:[wdillard] rid:[0x45b]
user:[lbradford] rid:[0x45c]
user:[sgage] rid:[0x45d]
user:[asanchez] rid:[0x45e]
user:[dbranch] rid:[0x45f]
user:[ccruz] rid:[0x460]
user:[njohnson] rid:[0x461]
user:[mholliday] rid:[0x462]
```

---

# Impacket Toolkit

**Impac**ketÂ **is**Â **a**Â **versat**ileÂ **toolk**itÂ **tha**tÂ **provi**desÂ **us**Â **wit**hÂ **man**yÂ **differ**entÂ **way**sÂ **to**Â **enumer**ate,Â **inter**act,Â **an**dÂ **explo**itÂ **Windo**wsÂ **protoc**olsÂ **an**dÂ **fin**dÂ **th**eÂ **inform**ationÂ **we**Â **nee**dÂ **usin**gÂ **Pyth**on.

## Using psexec.py

- **To**Â **conne**ctÂ **to**Â **a**Â **hos**tÂ **wit**hÂ **psex**ec.**py**,Â **we**Â **nee**dÂ **creden**tialsÂ **fo**rÂ **a**Â **use**rÂ **wit**hÂ **loca**lÂ **adminis**tratorÂ **privil**eges.

```Shell
psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125
```

## Using **wmiexec.py**

```Shell
wmiexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.5 
```

---

# Windapsearch

[Windapsearch](https://github.com/ropnop/windapsearch)Â **is**Â **anoth**erÂ **hand**yÂ **Pyth**onÂ **scri**ptÂ **we**Â **ca**nÂ **us**eÂ **to**Â **enumer**ateÂ **user**s,Â **grou**ps,Â **an**dÂ **comput**ersÂ **fro**mÂ **a**Â **Windo**wsÂ **doma**inÂ **by**Â **utiliz**ingÂ **LDA**PÂ **queri**es

## **Windapsearch -Â DomainÂ Admins**

```Shell
python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da
```

## **Windapsearch -Â PrivilegedÂ Users**

```Shell
python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU
```

---

# Bloodhound

## **BloodHound.pyÂ Options**

```Shell
bloodhound-python -h
```

## **ExecutingÂ BloodHound.py**

```Shell
sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all
```

Â **Onc**eÂ **th**eÂ **scri**ptÂ **finis**hes,Â **we**Â **wil**lÂ **se**eÂ **th**eÂ **outp**utÂ **file**sÂ **in**Â **th**eÂ **curre**ntÂ **worki**ngÂ **direct**oryÂ **in**Â **th**eÂ **form**atÂ **of**Â <**dat**e_**obje**ct.**jso**n>

```Shell
z3tssu@htb[/htb]$ ls

20220307163102_computers.json  20220307163102_domains.json  20220307163102_groups.json  20220307163102_users.json 
```

## **UploadÂ theÂ ZipÂ FileÂ intoÂ theÂ BloodHoundÂ GU**

### **BloodHound GUI Setup & Data Upload â€“ Notes**

### **ğŸ”¹ Step 1: Start Neo4j Database**

- Run the following command to start the Neo4j graph database service:
    
    ```Shell
    sudo neo4j start
    ```
    
- Neo4j is required for **storing** and **querying** the BloodHound data via **Cypher** queries.

### **ğŸ”¹ Step 2: Launch BloodHound GUI**

- From the Linux attack host (logged in via **FreeRDP**):
    
    ```Shell
    bloodhound
    ```
    
- This command launches the **BloodHound GUI desktop app**.

---

### **ğŸ”¹ Step 3: Log In (If Prompted)**

- The Linux attack host usually has credentials **pre-populated**.
- If prompted, use the following default credentials:
    
    ```Plain
    Username: neo4j
    Password: HTB_@cademy_stdnt!
    ```
    

---

### **ğŸ”¹ Step 4: Upload Collected Data**

- Once BloodHound GUI is loaded, you'll see a **blank interface**.
- Prepare your ingested JSON data:
    - Option 1: Upload individual `.json` files.
    - Option 2: Compress them first:
        
        ```Shell
        zip -r ilfreight_bh.zip *.json
        ```
        
- In the GUI:
    1. Click **"Upload Data"** (green arrow, right side).
    2. In the **file selection window**:
        - Choose either the **ZIP file** or **each JSON file**.
    3. Click **Open** to start the import.

![[image 1 11.png|image 1 11.png]]

---

## **SearchingÂ forÂ Relationships**

- Â **we**Â **ca**nÂ **us**eÂ **th**eÂ **Analy**sisÂ **ta**bÂ **to**Â **ru**nÂ **queri**esÂ **again**stÂ **th**eÂ **datab**ase.

![[Notion/CPTS/RESOURCES/image 2 8.png|image 2 8.png]]