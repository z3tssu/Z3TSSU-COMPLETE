- [[#Overview]]
- [[#User Enumeration Techniques]]
    - [[#1. SMB NULL Session Enumeration]]
        - [[#Using enum4linux:]]
        - [[#Using rpcclient:]]
        - [[#Using CrackMapExec —user Flag]]
    - [[#2. Gathering Users with LDAP Anonymous]]
        - [[#ldapsearch:]]
        - [[#windapsearch:]]
    - [[#3. Enumerating Users with Kerbrute]]
    - [[#4. Credentialed Enumeration to Build our User List]]
        - [[#Using CrackMapExec with Valid Credentials]]

---

# Overview

Building a precise and comprehensive list of valid domain usernames is essential to executing a successful password spraying attack. The effectiveness and stealth of the spray depend significantly on the quality of the username list and understanding of the domain’s password policy.

This section covers multiple enumeration methods, categorized by access level and tooling, to generate target user lists while minimizing detection and avoiding account lockouts.

---

# User Enumeration Techniques

## 1. SMB NULL Session Enumeration

**Description**: Anonymous SMB connections may allow enumeration of domain users and policy settings without valid credentials.

**Tools & Commands**:

### **Using enum4linux**:

```Shell
enum4linux -U <dc_ip> | grep "user:" | cut -f2 -d"[" | cut -f1 -d"]"

enum4linux -U 172.16.5.5 | grep "user:" | cut -f2 -d"[" | cut -f1 -d "]" > validUsers.txt
```

### **Using rpcclient**:

```Shell
rpcclient -U "" -N <dc_ip>
rpcclient $> enumdomusers
```

### Using CrackMapExec —user Flag

```Shell
crackmapexec smb 172.16.5.5 --users
```

**Output**: List of usernames

---

## 2. Gathering Users with LDAP Anonymous

**Description**: If LDAP allows anonymous access, user enumeration and policy retrieval are possible.

**Tools & Commands**:

### **ldapsearch**:

```Shell
ldapsearch -h <dc_ip> -x -b "DC=example,DC=com" -s sub "(&(objectclass=user))" | grep sAMAccountName: | cut -f2 -d" "
```

### **windapsearch**:

```Shell
./windapsearch.py --dc-ip <dc_ip> -u "" -U
```

**Output**: Usernames and userPrincipalNames

---

## 3. Enumerating Users with Kerbrute

**Description**:

- Uses Kerberos requests to determine valid usernames without triggering logon failures.
- If we have ==no access at all== from our position in the internal network, we can use Kerbrute to enumerate valid AD accounts and for password spraying.

==Useful Username List:== [https://github.com/insidetrust/statistically-likely-usernames/blob/master/jsmith.txt](https://github.com/insidetrust/statistically-likely-usernames/blob/master/jsmith.txt)

```Shell
kerbrute userenum -d <domain> --dc <dc_ip> /path/to/username_list.txt

\#Actual Command
kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt 
```

**Behavior**:

- Valid users return prompts for pre-authentication.
- Invalid users return "PRINCIPAL UNKNOWN".
- Event ID 4768 may be logged, but no failed logons (4625) are generated.

---

## 4. Credentialed Enumeration to Build our User List

**Description**: With valid domain credentials, tools can perform detailed and accurate user enumeration.

### Using CrackMapExec with Valid Credentials

```Shell
crackmapexec smb <dc_ip> -u <username> -p <password> --users

\#Actual Command: 
sudo crackmapexec smb 172.16.5.5 -u htb-student -p Academy_student_AD! --users
```

**Output Includes**:

- Domain usernames
- `badpwdcount` (failed login attempts)
- `baddpwdtime` (timestamp of last failed login)

---